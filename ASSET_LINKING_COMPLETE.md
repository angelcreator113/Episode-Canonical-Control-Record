# Asset Linking Implementation - Complete

## Summary
Implemented persistent asset linking between episodes and assets from the Asset Library. Assets imported via the "Import from Library" button now persist after page refresh.

## Changes Made

### 1. Backend Routes (`src/routes/footage.js`)
Added two new endpoints:

#### POST `/api/footage/episodes/:episodeId/assets`
- Links an array of asset IDs to an episode
- Uses the existing `episode_assets` junction table
- Validates that episode and all assets exist
- Returns updated episode with linked assets

**Request Body:**
```json
{
  "assetIds": ["asset-id-1", "asset-id-2", "..."]
}
```

**Response:**
```json
{
  "success": true,
  "episode": { ... },
  "message": "Successfully linked 2 asset(s) to episode"
}
```

#### GET `/api/footage/episodes/:episodeId/assets`
- Retrieves all assets linked to an episode
- Returns assets with full details (name, type, URLs, metadata)
- Uses Sequelize associations (belongsToMany through episode_assets)

**Response:**
```json
{
  "success": true,
  "assets": [
    {
      "id": "...",
      "name": "Brand Logo",
      "asset_type": "BRAND_LOGO",
      "s3_url_raw": "...",
      "metadata": { ... }
    }
  ],
  "count": 1
}
```

### 2. Frontend Service (`frontend/src/services/footageService.js`)
Added two new methods:

```javascript
// Link assets to episode
async linkAssetsToEpisode(episodeId, assetIds) {
  const response = await api.post(
    `/api/footage/episodes/${episodeId}/assets`,
    { assetIds }
  );
  return response.data;
}

// Get episode assets
async getEpisodeAssets(episodeId) {
  const response = await api.get(
    `/api/footage/episodes/${episodeId}/assets`
  );
  return response.data;
}
```

### 3. Frontend Component (`frontend/src/components/RawFootageUpload.jsx`)
Updated to persist and load imported assets:

#### loadImportedAssets()
```javascript
const loadImportedAssets = async () => {
  try {
    const response = await footageService.getEpisodeAssets(episodeId);
    if (response.success && response.assets) {
      setImportedAssets(response.assets);
      console.log('Loaded imported assets:', response.assets);
    }
  } catch (error) {
    console.error('Failed to load imported assets:', error);
  }
};
```

#### handleImportAssets() - Updated
```javascript
const handleImportAssets = async (assets) => {
  try {
    // Link assets to episode via API
    const assetIds = assets.map(asset => asset.id);
    const response = await footageService.linkAssetsToEpisode(episodeId, assetIds);
    
    if (response.success) {
      setImportedAssets(prev => [...prev, ...assets]);
      console.log('Successfully linked assets:', assets.map(a => a.name));
    }
  } catch (error) {
    console.error('Failed to link assets:', error);
    setErrors(prev => [...prev, {
      filename: 'Asset Import',
      message: 'Failed to link assets to episode'
    }]);
  }
};
```

#### useEffect - Updated
```javascript
useEffect(() => {
  loadExistingFootage();
  loadImportedAssets(); // ← Added this line
}, [episodeId]);
```

## Database Structure
Uses existing `episode_assets` junction table defined in `src/models/Episode.js`:

```javascript
Episode.belongsToMany(models.Asset, {
  through: 'episode_assets',
  foreignKey: 'episode_id',
  otherKey: 'asset_id',
  as: 'assets',
});
```

## Testing

### Test the GET endpoint:
```powershell
Invoke-RestMethod -Uri "http://localhost:3002/api/footage/episodes/{episodeId}/assets" -Method Get
```

### Test the POST endpoint:
```powershell
$body = @{
    assetIds = @("asset-id-1", "asset-id-2")
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3002/api/footage/episodes/{episodeId}/assets" `
    -Method Post `
    -Body $body `
    -ContentType "application/json"
```

### Test in UI:
1. Go to Raw Footage Upload page
2. Click "Import from Library"
3. Select one or more approved assets
4. Click "Import Selected"
5. Assets should appear in the "Imported from Library" section
6. Refresh the page
7. ✅ Assets should still be there!

## Files Modified

1. **src/routes/footage.js** - Added POST and GET routes for asset linking
2. **frontend/src/services/footageService.js** - Added linkAssetsToEpisode() and getEpisodeAssets()
3. **frontend/src/components/RawFootageUpload.jsx** - Updated to persist imported assets
   - Added loadImportedAssets()
   - Updated handleImportAssets() to call API
   - Updated useEffect to load assets on mount

## Implementation Notes

- Uses existing database schema (episode_assets table)
- Leverages Sequelize's belongsToMany associations  
- Uses addAssets() method (auto-generated by Sequelize)
- Atomic operation - validates all assets exist before linking
- Returns full asset details including metadata and URLs
- Proper error handling with user-friendly error messages
- Console logging for debugging

## Status
✅ **Complete and tested**

The TODO comment in handleImportAssets() has been removed and the functionality is now fully implemented.

## Next Steps

Potential enhancements:
1. Add DELETE `/api/footage/episodes/:episodeId/assets/:assetId` to unlink specific assets
2. Add visual indication of which assets are imported vs uploaded
3. Show asset thumbnails in the imported assets section
4. Add drag-and-drop reordering of imported assets
5. Add bulk operations (link multiple, unlink multiple)
