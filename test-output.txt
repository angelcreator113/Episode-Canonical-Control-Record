
> episode-metadata-api@1.0.0 test
> cross-env NODE_ENV=test jest --coverage --runInBand

FAIL tests/unit/models/activityLog.test.js
  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have logActivity method

    TypeError: Cannot set properties of undefined (setting 'logActivity')

      14 |   describe('Model Methods', () => {
      15 |     test('should have logActivity method', () => {
    > 16 |       ActivityLogModel.logActivity = jest.fn().mockResolvedValue({ id: 1 });
         |                                   ^
      17 |
      18 |       expect(typeof ActivityLogModel.logActivity).toBe('function');
      19 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:16:35)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have getUserHistory method

    TypeError: Cannot set properties of undefined (setting 'getUserHistory')

      20 |
      21 |     test('should have getUserHistory method', () => {
    > 22 |       ActivityLogModel.getUserHistory = jest.fn().mockResolvedValue([]);
         |                                      ^
      23 |
      24 |       expect(typeof ActivityLogModel.getUserHistory).toBe('function');
      25 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:22:38)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have getResourceHistory method

    TypeError: Cannot set properties of undefined (setting 'getResourceHistory')

      26 |
      27 |     test('should have getResourceHistory method', () => {
    > 28 |       ActivityLogModel.getResourceHistory = jest.fn().mockResolvedValue([]);
         |                                          ^
      29 |
      30 |       expect(typeof ActivityLogModel.getResourceHistory).toBe('function');
      31 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:28:42)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have getAuditTrail method

    TypeError: Cannot set properties of undefined (setting 'getAuditTrail')

      32 |
      33 |     test('should have getAuditTrail method', () => {
    > 34 |       ActivityLogModel.getAuditTrail = jest.fn().mockResolvedValue([]);
         |                                     ^
      35 |
      36 |       expect(typeof ActivityLogModel.getAuditTrail).toBe('function');
      37 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:34:37)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have getStats method

    TypeError: Cannot set properties of undefined (setting 'getStats')

      38 |
      39 |     test('should have getStats method', () => {
    > 40 |       ActivityLogModel.getStats = jest.fn().mockResolvedValue({});
         |                                ^
      41 |
      42 |       expect(typeof ActivityLogModel.getStats).toBe('function');
      43 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:40:32)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have create method (standard Sequelize)

    TypeError: Cannot set properties of undefined (setting 'create')

      44 |
      45 |     test('should have create method (standard Sequelize)', () => {
    > 46 |       ActivityLogModel.create = jest.fn().mockResolvedValue({ id: 1 });
         |                              ^
      47 |
      48 |       expect(typeof ActivityLogModel.create).toBe('function');
      49 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:46:30)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have findAll method (standard Sequelize)

    TypeError: Cannot set properties of undefined (setting 'findAll')

      50 |
      51 |     test('should have findAll method (standard Sequelize)', () => {
    > 52 |       ActivityLogModel.findAll = jest.fn().mockResolvedValue([]);
         |                               ^
      53 |
      54 |       expect(typeof ActivityLogModel.findAll).toBe('function');
      55 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:52:31)

  ΓùÅ ActivityLog Model ΓÇ║ Model Methods ΓÇ║ should have findByPk method (standard Sequelize)

    TypeError: Cannot set properties of undefined (setting 'findByPk')

      56 |
      57 |     test('should have findByPk method (standard Sequelize)', () => {
    > 58 |       ActivityLogModel.findByPk = jest.fn().mockResolvedValue({ id: 1 });
         |                                ^
      59 |
      60 |       expect(typeof ActivityLogModel.findByPk).toBe('function');
      61 |     });

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:58:32)

  ΓùÅ ActivityLog Model ΓÇ║ logActivity Method ΓÇ║ should log activity with required fields

    TypeError: Cannot set properties of undefined (setting 'logActivity')

      64 |   describe('logActivity Method', () => {
      65 |     test('should log activity with required fields', async () => {
    > 66 |       ActivityLogModel.logActivity = jest.fn().mockResolvedValue({ id: 1 });
         |                                   ^
      67 |
      68 |       const result = await ActivityLogModel.logActivity({
      69 |         userId: 'user-123',

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:66:35)

  ΓùÅ ActivityLog Model ΓÇ║ logActivity Method ΓÇ║ should log activity with optional fields

    TypeError: Cannot set properties of undefined (setting 'logActivity')

      85 |
      86 |     test('should log activity with optional fields', async () => {
    > 87 |       ActivityLogModel.logActivity = jest.fn().mockResolvedValue({ id: 1 });
         |                                   ^
      88 |
      89 |       await ActivityLogModel.logActivity({
      90 |         userId: 'user-456',

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:87:35)

  ΓùÅ ActivityLog Model ΓÇ║ logActivity Method ΓÇ║ should support different action types

    TypeError: Cannot set properties of undefined (setting 'logActivity')

      102 |
      103 |     test('should support different action types', async () => {
    > 104 |       ActivityLogModel.logActivity = jest.fn().mockResolvedValue({ id: 1 });
          |                                   ^
      105 |
      106 |       const actions = ['view', 'create', 'edit', 'delete', 'download', 'upload'];
      107 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:104:35)

  ΓùÅ ActivityLog Model ΓÇ║ logActivity Method ΓÇ║ should support different resource types

    TypeError: Cannot set properties of undefined (setting 'logActivity')

      124 |
      125 |       for (const resource of resources) {
    > 126 |         ActivityLogModel.logActivity = jest.fn().mockResolvedValue({ id: 1 });
          |                                     ^
      127 |
      128 |         await ActivityLogModel.logActivity({
      129 |           userId: 'user-123',

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:126:37)

  ΓùÅ ActivityLog Model ΓÇ║ logActivity Method ΓÇ║ should handle database errors

    TypeError: Cannot set properties of undefined (setting 'logActivity')

      138 |
      139 |     test('should handle database errors', async () => {
    > 140 |       ActivityLogModel.logActivity = jest
          |                                   ^
      141 |         .fn()
      142 |         .mockRejectedValue(new Error('DB Error'));
      143 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:140:35)

  ΓùÅ ActivityLog Model ΓÇ║ getUserHistory Method ΓÇ║ should retrieve user activity history

    TypeError: Cannot set properties of undefined (setting 'getUserHistory')

      163 |       ];
      164 |
    > 165 |       ActivityLogModel.getUserHistory = jest.fn().mockResolvedValue(mockLogs);
          |                                      ^
      166 |
      167 |       const result = await ActivityLogModel.getUserHistory('user-123');
      168 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:165:38)

  ΓùÅ ActivityLog Model ΓÇ║ getUserHistory Method ΓÇ║ should support pagination options

    TypeError: Cannot set properties of undefined (setting 'getUserHistory')

      172 |
      173 |     test('should support pagination options', async () => {
    > 174 |       ActivityLogModel.getUserHistory = jest.fn().mockResolvedValue([]);
          |                                      ^
      175 |
      176 |       await ActivityLogModel.getUserHistory('user-123', { limit: 50, offset: 0 });
      177 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:174:38)

  ΓùÅ ActivityLog Model ΓÇ║ getUserHistory Method ΓÇ║ should return empty array when no records found

    TypeError: Cannot set properties of undefined (setting 'getUserHistory')

      183 |
      184 |     test('should return empty array when no records found', async () => {
    > 185 |       ActivityLogModel.getUserHistory = jest.fn().mockResolvedValue([]);
          |                                      ^
      186 |
      187 |       const result = await ActivityLogModel.getUserHistory('user-nonexistent');
      188 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:185:38)

  ΓùÅ ActivityLog Model ΓÇ║ getUserHistory Method ΓÇ║ should handle database errors

    TypeError: Cannot set properties of undefined (setting 'getUserHistory')

      191 |
      192 |     test('should handle database errors', async () => {
    > 193 |       ActivityLogModel.getUserHistory = jest
          |                                      ^
      194 |         .fn()
      195 |         .mockRejectedValue(new Error('DB Error'));
      196 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:193:38)

  ΓùÅ ActivityLog Model ΓÇ║ getResourceHistory Method ΓÇ║ should retrieve resource activity history

    TypeError: Cannot set properties of undefined (setting 'getResourceHistory')

      211 |       ];
      212 |
    > 213 |       ActivityLogModel.getResourceHistory = jest.fn().mockResolvedValue(mockLogs);
          |                                          ^
      214 |
      215 |       const result = await ActivityLogModel.getResourceHistory('episode', 1);
      216 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:213:42)

  ΓùÅ ActivityLog Model ΓÇ║ getResourceHistory Method ΓÇ║ should support different resource types

    TypeError: Cannot set properties of undefined (setting 'getResourceHistory')

      220 |
      221 |     test('should support different resource types', async () => {
    > 222 |       ActivityLogModel.getResourceHistory = jest.fn().mockResolvedValue([]);
          |                                          ^
      223 |
      224 |       const resources = ['episode', 'thumbnail', 'metadata', 'processing'];
      225 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:222:42)

  ΓùÅ ActivityLog Model ΓÇ║ getResourceHistory Method ΓÇ║ should return empty array on error

    TypeError: Cannot set properties of undefined (setting 'getResourceHistory')

      234 |
      235 |     test('should return empty array on error', async () => {
    > 236 |       ActivityLogModel.getResourceHistory = jest
          |                                          ^
      237 |         .fn()
      238 |         .mockRejectedValue(new Error('Error'));
      239 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:236:42)

  ΓùÅ ActivityLog Model ΓÇ║ getAuditTrail Method ΓÇ║ should retrieve full audit trail

    TypeError: Cannot set properties of undefined (setting 'getAuditTrail')

      254 |       ];
      255 |
    > 256 |       ActivityLogModel.getAuditTrail = jest.fn().mockResolvedValue(mockTrail);
          |                                     ^
      257 |
      258 |       const result = await ActivityLogModel.getAuditTrail({ limit: 10 });
      259 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:256:37)

  ΓùÅ ActivityLog Model ΓÇ║ getAuditTrail Method ΓÇ║ should support filtering options

    TypeError: Cannot set properties of undefined (setting 'getAuditTrail')

      262 |
      263 |     test('should support filtering options', async () => {
    > 264 |       ActivityLogModel.getAuditTrail = jest.fn().mockResolvedValue([]);
          |                                     ^
      265 |
      266 |       await ActivityLogModel.getAuditTrail({
      267 |         actionType: 'delete',

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:264:37)

  ΓùÅ ActivityLog Model ΓÇ║ getAuditTrail Method ΓÇ║ should return empty array on error

    TypeError: Cannot set properties of undefined (setting 'getAuditTrail')

      274 |
      275 |     test('should return empty array on error', async () => {
    > 276 |       ActivityLogModel.getAuditTrail = jest
          |                                     ^
      277 |         .fn()
      278 |         .mockRejectedValue(new Error('Error'));
      279 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:276:37)

  ΓùÅ ActivityLog Model ΓÇ║ getStats Method ΓÇ║ should retrieve activity statistics

    TypeError: Cannot set properties of undefined (setting 'getStats')

      294 |       };
      295 |
    > 296 |       ActivityLogModel.getStats = jest.fn().mockResolvedValue(mockStats);
          |                                ^
      297 |
      298 |       const result = await ActivityLogModel.getStats('7d');
      299 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:296:32)

  ΓùÅ ActivityLog Model ΓÇ║ getStats Method ΓÇ║ should support different time ranges

    TypeError: Cannot set properties of undefined (setting 'getStats')

      303 |
      304 |     test('should support different time ranges', async () => {
    > 305 |       ActivityLogModel.getStats = jest.fn().mockResolvedValue({});
          |                                ^
      306 |
      307 |       const ranges = ['1d', '7d', '30d', '90d'];
      308 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:305:32)

  ΓùÅ ActivityLog Model ΓÇ║ getStats Method ΓÇ║ should return empty object on error

    TypeError: Cannot set properties of undefined (setting 'getStats')

      317 |
      318 |     test('should return empty object on error', async () => {
    > 319 |       ActivityLogModel.getStats = jest
          |                                ^
      320 |         .fn()
      321 |         .mockRejectedValue(new Error('Error'));
      322 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:319:32)

  ΓùÅ ActivityLog Model ΓÇ║ Standard Sequelize Methods ΓÇ║ should support create

    TypeError: Cannot set properties of undefined (setting 'create')

      332 |   describe('Standard Sequelize Methods', () => {
      333 |     test('should support create', async () => {
    > 334 |       ActivityLogModel.create = jest
          |                              ^
      335 |         .fn()
      336 |         .mockResolvedValue({ id: 1, userId: 'user-123' });
      337 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:334:30)

  ΓùÅ ActivityLog Model ΓÇ║ Standard Sequelize Methods ΓÇ║ should support findAll

    TypeError: Cannot set properties of undefined (setting 'findAll')

      347 |
      348 |     test('should support findAll', async () => {
    > 349 |       ActivityLogModel.findAll = jest.fn().mockResolvedValue([
          |                               ^
      350 |         { id: 1, userId: 'user-123' },
      351 |         { id: 2, userId: 'user-456' },
      352 |       ]);

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:349:31)

  ΓùÅ ActivityLog Model ΓÇ║ Standard Sequelize Methods ΓÇ║ should support findByPk

    TypeError: Cannot set properties of undefined (setting 'findByPk')

      358 |
      359 |     test('should support findByPk', async () => {
    > 360 |       ActivityLogModel.findByPk = jest
          |                                ^
      361 |         .fn()
      362 |         .mockResolvedValue({ id: 1, userId: 'user-123' });
      363 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:360:32)

  ΓùÅ ActivityLog Model ΓÇ║ Standard Sequelize Methods ΓÇ║ should support findOne

    TypeError: Cannot set properties of undefined (setting 'findOne')

      368 |
      369 |     test('should support findOne', async () => {
    > 370 |       ActivityLogModel.findOne = jest
          |                               ^
      371 |         .fn()
      372 |         .mockResolvedValue({ id: 1, userId: 'user-123' });
      373 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:370:31)

  ΓùÅ ActivityLog Model ΓÇ║ Sequelize Association Support ΓÇ║ should support hasMany

    TypeError: Cannot set properties of undefined (setting 'hasMany')

      397 |   describe('Sequelize Association Support', () => {
      398 |     test('should support hasMany', () => {
    > 399 |       ActivityLogModel.hasMany = jest.fn();
          |                               ^
      400 |
      401 |       ActivityLogModel.hasMany({
      402 |         model: 'Episode',

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:399:31)

  ΓùÅ ActivityLog Model ΓÇ║ Sequelize Association Support ΓÇ║ should support belongsTo

    TypeError: Cannot set properties of undefined (setting 'belongsTo')

      408 |
      409 |     test('should support belongsTo', () => {
    > 410 |       ActivityLogModel.belongsTo = jest.fn();
          |                                 ^
      411 |
      412 |       ActivityLogModel.belongsTo('User', { foreignKey: 'userId' });
      413 |

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:410:33)

  ΓùÅ ActivityLog Model ΓÇ║ Hook Support ΓÇ║ should support beforeCreate hook

    TypeError: Cannot set properties of undefined (setting 'beforeCreate')

      418 |   describe('Hook Support', () => {
      419 |     test('should support beforeCreate hook', () => {
    > 420 |       ActivityLogModel.beforeCreate = jest.fn();
          |                                    ^
      421 |
      422 |       ActivityLogModel.beforeCreate((log) => {
      423 |         log.timestamp = new Date();

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:420:36)

  ΓùÅ ActivityLog Model ΓÇ║ Hook Support ΓÇ║ should support beforeValidate hook

    TypeError: Cannot set properties of undefined (setting 'beforeValidate')

      428 |
      429 |     test('should support beforeValidate hook', () => {
    > 430 |       ActivityLogModel.beforeValidate = jest.fn();
          |                                      ^
      431 |
      432 |       ActivityLogModel.beforeValidate((log) => {
      433 |         // normalize data

      at Object.<anonymous> (tests/unit/models/activityLog.test.js:430:38)

PASS tests/unit/app.test.js
  ΓùÅ Console

    console.log
      Γ£ô Test mode - database initialization skipped

      at Object.log (src/app.js:50:11)

PASS tests/unit/middleware/auditLog.test.js
  ΓùÅ Console

    console.error
      Error logging action: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:82:28)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      182 |       });
      183 |     } catch (error) {
    > 184 |       console.error('Error logging action:', error);
          |               ^
      185 |       return null;
      186 |     }
      187 |   },

      at Object.error [as logAction] (src/middleware/auditLog.js:184:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:85:22)

    console.error
      Error fetching user history: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:110:71)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      198 |       return await ActivityLog.getUserHistory(userId, options);
      199 |     } catch (error) {
    > 200 |       console.error('Error fetching user history:', error);
          |               ^
      201 |       return [];
      202 |     }
      203 |   },

      at Object.error [as getUserHistory] (src/middleware/auditLog.js:200:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:112:20)

    console.error
      Error fetching resource history: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:132:75)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      214 |       return await ActivityLog.getResourceHistory(resourceType, resourceId);
      215 |     } catch (error) {
    > 216 |       console.error('Error fetching resource history:', error);
          |               ^
      217 |       return [];
      218 |     }
      219 |   },

      at Object.error [as getResourceHistory] (src/middleware/auditLog.js:216:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:134:20)

    console.error
      Error fetching audit trail: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:158:70)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      230 |       return await ActivityLog.getAuditTrail(options);
      231 |     } catch (error) {
    > 232 |       console.error('Error fetching audit trail:', error);
          |               ^
      233 |       return [];
      234 |     }
      235 |   },

      at Object.error [as getAuditTrail] (src/middleware/auditLog.js:232:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:160:21)

    console.error
      Error fetching stats: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:182:65)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      246 |       return await ActivityLog.getStats(timeRange);
      247 |     } catch (error) {
    > 248 |       console.error('Error fetching stats:', error);
          |               ^
      249 |       return {};
      250 |     }
      251 |   },

      at Object.error [as getStats] (src/middleware/auditLog.js:248:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:184:21)

    console.error
      Error logging action: Error: Connection error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:492:68)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      182 |       });
      183 |     } catch (error) {
    > 184 |       console.error('Error logging action:', error);
          |               ^
      185 |       return null;
      186 |     }
      187 |   },

      at Object.error [as logAction] (src/middleware/auditLog.js:184:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:494:22)

    console.error
      Error fetching stats: Error: Stats error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:668:65)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      246 |       return await ActivityLog.getStats(timeRange);
      247 |     } catch (error) {
    > 248 |       console.error('Error fetching stats:', error);
          |               ^
      249 |       return {};
      250 |     }
      251 |   },

      at Object.error [as getStats] (src/middleware/auditLog.js:248:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:670:21)

PASS tests/unit/controllers/episode.test.js
PASS tests/unit/controllers/processing.test.js
PASS tests/unit/controllers/thumbnail.test.js
PASS tests/unit/controllers/metadata.test.js
PASS tests/unit/middleware/rbac.test.js
PASS tests/unit/middleware/errorHandler.test.js
PASS tests/unit/models/metadata-methods.test.js
PASS tests/unit/middleware/auth.test.js
PASS tests/api/endpoints.test.js
PASS tests/unit/models/episode.test.js
PASS tests/unit/middleware/auth-gaps.test.js
--------------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------
File                                        | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                       
--------------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------
All files                                   |   71.13 |    52.68 |   58.53 |   71.26 |                                                                         
 src                                        |   61.19 |    34.61 |      20 |   61.19 |                                                                         
  app.js                                    |   61.19 |    34.61 |      20 |   61.19 | 16-37,44-45,96-102,126,162-165                                          
 src/config                                 |       0 |        0 |       0 |       0 |                                                                         
  aws.js                                    |       0 |        0 |     100 |       0 | 7-17                                                                    
  database.js                               |       0 |        0 |       0 |       0 | 7-36                                                                    
  environment.js                            |       0 |        0 |     100 |       0 | 5-47                                                                    
  sequelize.js                              |       0 |        0 |     100 |       0 | 6                                                                       
 src/controllers                            |   82.99 |    54.01 |   95.83 |   82.89 |                                                                         
  episodeController.js                      |   97.01 |    73.07 |     100 |   96.92 | 206,247                                                                 
  metadataController.js                     |   71.42 |    46.66 |      90 |   71.11 | 75,102,137,146,198,221-229,278,311,319,349-390,404                      
  processingController.js                   |   88.65 |    67.85 |     100 |   89.36 | 86,111,123,134,178,185,202,235,284,327                                  
  thumbnailController.js                    |   78.26 |     37.7 |    90.9 |   77.77 | 77,111-167,182,199,233,267,300,352,387                                  
 src/middleware                             |   82.03 |     78.1 |   81.48 |   82.25 |                                                                         
  auditLog.js                               |   69.76 |    58.82 |    64.7 |   70.23 | 67-78,110-116,126-155,170,195,211,227,243                               
  auth.js                                   |   61.66 |    52.94 |      60 |   61.66 | 50,69,114,135-166,175-192                                               
  errorHandler.js                           |     100 |    95.18 |     100 |     100 | 66-75,193,233                                                           
  rbac.js                                   |   92.98 |     90.9 |   84.61 |   92.98 | 68,83,141,178                                                           
 src/migrations                             |       0 |      100 |       0 |       0 |                                                                         
  20240101000001-create-episodes.js         |       0 |      100 |       0 |       0 | 3-125                                                                   
  20240101000002-create-metadata-storage.js |       0 |      100 |       0 |       0 | 3-67                                                                    
  20240101000003-create-thumbnails.js       |       0 |      100 |       0 |       0 | 3-87                                                                    
  20240101000004-create-processing-queue.js |       0 |      100 |       0 |       0 | 3-92                                                                    
  20240101000005-create-activity-logs.js    |       0 |      100 |       0 |       0 | 3-73                                                                    
 src/models                                 |   39.59 |        0 |   11.36 |   40.41 |                                                                         
  ActivityLog.js                            |    37.5 |        0 |   16.66 |   42.85 | 117,133,144,154-164,174-189                                             
  Episode.js                                |   46.42 |        0 |      10 |   46.42 | 216-217,224-225,232-236,243,261,268,278,287-290,297                     
  MetadataStorage.js                        |      36 |        0 |   16.66 |      36 | 106-108,115-117,124-127,138,147-160                                     
  ProcessingQueue.js                        |   35.55 |        0 |    7.69 |   35.55 | 137-139,146-148,155-158,165-173,180,187-190,201,213,224,234,247,257-267 
  Thumbnail.js                              |   44.44 |        0 |   11.11 |   44.44 | 149-150,157-160,167-171,182,194,207,220-232,239                         
 src/routes                                 |     100 |      100 |     100 |     100 |                                                                         
  episodes.js                               |     100 |      100 |     100 |     100 |                                                                         
  metadata.js                               |     100 |      100 |     100 |     100 |                                                                         
  processing.js                             |     100 |      100 |     100 |     100 |                                                                         
  thumbnails.js                             |     100 |      100 |     100 |     100 |                                                                         
--------------------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (75%) not met: 71.13%
Jest: "global" coverage threshold for branches (75%) not met: 52.68%
Jest: "global" coverage threshold for lines (75%) not met: 71.26%
Jest: "global" coverage threshold for functions (75%) not met: 58.53%

Test Suites: 1 failed, 13 passed, 14 total
Tests:       34 failed, 501 passed, 535 total
Snapshots:   0 total
Time:        4.959 s, estimated 5 s
Ran all test suites.
