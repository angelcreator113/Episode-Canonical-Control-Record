
> episode-metadata-api@1.0.0 test
> cross-env NODE_ENV=test jest --coverage --runInBand

FAIL tests/unit/controllers/metadata.test.js
  ΓùÅ Console

    console.error
      Metadata query error (schema mismatch): DB error

      60 |     } catch (error) {
      61 |       // If metadata table schema is mismatched, return empty list
    > 62 |       console.error('Metadata query error (schema mismatch):', error.message);
         |               ^
      63 |       res.json({
      64 |         data: [],
      65 |         pagination: {

      at Object.error [as listMetadata] (src/controllers/metadataController.js:62:15)
      at Object.<anonymous> (tests/unit/controllers/metadata.test.js:288:7)

  ΓùÅ Metadata Controller ΓÇ║ Error Handling ΓÇ║ should handle database errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500

    Number of calls: 0

      288 |       await metadataController.listMetadata(mockReq, mockRes);
      289 |
    > 290 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      291 |     });
      292 |   });
      293 | });

      at Object.toHaveBeenCalledWith (tests/unit/controllers/metadata.test.js:290:30)

PASS tests/unit/app.test.js
  ΓùÅ Console

    console.log
      ≡ƒÜÇ Starting Episode Metadata API...

      at Object.log (src/app.js:69:9)

    console.log
      ≡ƒôª Node version: v20.19.4

      at Object.log (src/app.js:70:9)

    console.log
      ≡ƒöº Environment: test

      at Object.log (src/app.js:71:9)

    console.log
      Γ£ô Auth routes loaded

      at Object.log (src/app.js:143:11)

    console.log
      Γ£ô Episodes routes loaded

      at Object.log (src/app.js:159:11)

    console.log
      Γ£ô Thumbnails routes loaded

      at Object.log (src/app.js:167:11)

    console.log
      Γ£ô Metadata routes loaded

      at Object.log (src/app.js:175:11)

    console.log
      Γ£ô Processing routes loaded

      at Object.log (src/app.js:183:11)

    console.log
      Γ£ô Files routes loaded

      at Object.log (src/app.js:192:11)

    console.log
      Γ£ô Search routes loaded

      at Object.log (src/app.js:200:11)

    console.log
      Γ£ô Jobs routes loaded

      at Object.log (src/app.js:208:11)

    console.log
      Γ£ô Assets routes loaded

      at Object.log (src/app.js:217:11)

    console.error
      Γ£ù Failed to load compositions routes: Cannot find module '../db' from 'src/services/VersioningService.js'
      
      Require stack:
        src/services/VersioningService.js
        src/routes/compositions.js
        src/app.js
        tests/unit/app.test.js

      225 |   console.log('Γ£ô Compositions routes loaded');
      226 | } catch (e) {
    > 227 |   console.error('Γ£ù Failed to load compositions routes:', e.message);
          |           ^
      228 |   compositionRoutes = (req, res) => res.status(500).json({ error: 'Routes not available' });
      229 | }
      230 |

      at Object.error (src/app.js:227:11)
      at Object.require (tests/unit/app.test.js:11:11)

    console.log
      Γ£ô Templates routes loaded

      at Object.log (src/app.js:233:11)

    console.log
      Γ£ô Seed routes loaded (development only)

      at Object.log (src/app.js:243:11)

PASS tests/unit/controllers/thumbnail.test.js
  ΓùÅ Console

    console.error
      Γ¥î Error in listThumbnails: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\controllers\thumbnail.test.js:321:70)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      63 |       });
      64 |     } catch (error) {
    > 65 |       console.error('Γ¥î Error in listThumbnails:', error);
         |               ^
      66 |       res.status(500).json({
      67 |         error: 'Failed to list thumbnails',
      68 |         message: error.message

      at Object.error [as listThumbnails] (src/controllers/thumbnailController.js:65:15)
      at Object.<anonymous> (tests/unit/controllers/thumbnail.test.js:323:7)

PASS tests/unit/middleware/auditLog.test.js
  ΓùÅ Console

    console.error
      Error logging action: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:82:28)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      182 |       });
      183 |     } catch (error) {
    > 184 |       console.error('Error logging action:', error);
          |               ^
      185 |       return null;
      186 |     }
      187 |   },

      at Object.error [as logAction] (src/middleware/auditLog.js:184:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:85:22)

    console.error
      Error fetching user history: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:110:71)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      198 |       return await ActivityLog.getUserHistory(userId, options);
      199 |     } catch (error) {
    > 200 |       console.error('Error fetching user history:', error);
          |               ^
      201 |       return [];
      202 |     }
      203 |   },

      at Object.error [as getUserHistory] (src/middleware/auditLog.js:200:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:112:20)

    console.error
      Error fetching resource history: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:132:75)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      214 |       return await ActivityLog.getResourceHistory(resourceType, resourceId);
      215 |     } catch (error) {
    > 216 |       console.error('Error fetching resource history:', error);
          |               ^
      217 |       return [];
      218 |     }
      219 |   },

      at Object.error [as getResourceHistory] (src/middleware/auditLog.js:216:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:134:20)

    console.error
      Error fetching audit trail: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:158:70)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      230 |       return await ActivityLog.getAuditTrail(options);
      231 |     } catch (error) {
    > 232 |       console.error('Error fetching audit trail:', error);
          |               ^
      233 |       return [];
      234 |     }
      235 |   },

      at Object.error [as getAuditTrail] (src/middleware/auditLog.js:232:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:160:21)

    console.error
      Error fetching stats: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:182:65)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      246 |       return await ActivityLog.getStats(timeRange);
      247 |     } catch (error) {
    > 248 |       console.error('Error fetching stats:', error);
          |               ^
      249 |       return {};
      250 |     }
      251 |   },

      at Object.error [as getStats] (src/middleware/auditLog.js:248:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:184:21)

    console.error
      Error logging action: Error: Connection error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:492:68)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      182 |       });
      183 |     } catch (error) {
    > 184 |       console.error('Error logging action:', error);
          |               ^
      185 |       return null;
      186 |     }
      187 |   },

      at Object.error [as logAction] (src/middleware/auditLog.js:184:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:494:22)

    console.error
      Error fetching stats: Error: Stats error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:668:65)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      246 |       return await ActivityLog.getStats(timeRange);
      247 |     } catch (error) {
    > 248 |       console.error('Error fetching stats:', error);
          |               ^
      249 |       return {};
      250 |     }
      251 |   },

      at Object.error [as getStats] (src/middleware/auditLog.js:248:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:670:21)

PASS tests/unit/controllers/processing.test.js
PASS tests/unit/controllers/episode.test.js
  ΓùÅ Console

    console.error
      Γ¥î Error in listEpisodes: Error: DB connection failed
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\controllers\episode.test.js:491:23)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      56 |       });
      57 |     } catch (error) {
    > 58 |       console.error('Γ¥î Error in listEpisodes:', error);
         |               ^
      59 |       res.status(500).json({
      60 |         error: 'Failed to list episodes',
      61 |         message: error.message

      at Object.error [as listEpisodes] (src/controllers/episodeController.js:58:15)
      at Object.<anonymous> (tests/unit/controllers/episode.test.js:494:7)

PASS tests/unit/middleware/auditLog-additional.test.js
PASS tests/unit/middleware/rbac.test.js
PASS tests/unit/middleware/errorHandler.test.js
PASS tests/unit/services/JobQueueService.test.js
PASS tests/unit/services/OpenSearchService.test.js
PASS tests/unit/controllers/jobController.test.js
PASS tests/api/endpoints.test.js
PASS tests/unit/models/episode.test.js
PASS tests/unit/services/S3Service.test.js
PASS tests/unit/middleware/auth.test.js
PASS tests/unit/models/activityLog.test.js
PASS tests/unit/models/metadata-methods.test.js
PASS tests/unit/controllers/searchController.test.js
PASS tests/unit/services/FileValidationService.test.js
PASS tests/unit/controllers/fileController.test.js
PASS tests/unit/middleware/auth-gaps.test.js
-----------------------------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------------
File                                                 | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                 
-----------------------------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------------
All files                                            |   46.11 |    32.87 |   39.45 |   46.61 |                                                                                                                                   
 src                                                 |   46.48 |    21.05 |    4.16 |   49.71 |                                                                                                                                   
  app.js                                             |   55.12 |    26.66 |    5.26 |   59.72 | 18-47,56,60-62,79,122-128,145-146,161-162,169-170,177-178,185-186,194-195,202-203,210-211,219-220,225,235-236,245-246,269,306-308 
  server.js                                          |       0 |        0 |       0 |       0 | 7-76                                                                                                                              
 src/config                                          |       0 |        0 |       0 |       0 |                                                                                                                                   
  aws.js                                             |       0 |        0 |     100 |       0 | 7-17                                                                                                                              
  database.js                                        |       0 |        0 |       0 |       0 | 7-36                                                                                                                              
  environment.js                                     |       0 |        0 |     100 |       0 | 5-47                                                                                                                              
  sequelize.js                                       |       0 |        0 |     100 |       0 | 6                                                                                                                                 
 src/controllers                                     |   85.08 |    63.18 |    94.2 |   85.19 |                                                                                                                                   
  episodeController.js                               |      92 |       74 |     100 |   91.89 | 102-103,162-163,206,247                                                                                                           
  fileController.js                                  |   84.72 |    77.77 |   83.33 |   86.95 | 236-266                                                                                                                           
  jobController.js                                   |     100 |      100 |     100 |     100 |                                                                                                                                   
  metadataController.js                              |   72.34 |    46.66 |      90 |   72.04 | 91,118,153,162,214,237-245,294,327,335,365-406,420                                                                                
  processingController.js                            |   88.65 |    67.85 |     100 |   89.36 | 86,111,123,134,178,185,202,235,284,327                                                                                            
  searchController.js                                |   89.58 |      100 |   88.88 |   88.88 | 98-104                                                                                                                            
  thumbnailController.js                             |   77.08 |    36.84 |    90.9 |   76.59 | 104,112-192,207,224,258,292,325,377,412                                                                                           
 src/middleware                                      |   65.98 |    59.17 |   67.16 |   66.41 |                                                                                                                                   
  auditLog.js                                        |   69.76 |    58.82 |    64.7 |   70.23 | 67-78,110-116,126-155,170,195,211,227,243                                                                                         
  auth.js                                            |   58.57 |    45.23 |      50 |   59.42 | 50,69,114,135-166,175-192,206-222                                                                                                 
  errorHandler.js                                    |     100 |    95.18 |     100 |     100 | 66-75,193,233                                                                                                                     
  jwtAuth.js                                         |   12.72 |        0 |       0 |   12.96 | 14-61,74-111,120-139,148-167                                                                                                      
  rbac.js                                            |   92.98 |     90.9 |   84.61 |   92.98 | 68,83,141,178                                                                                                                     
  searchLogger.js                                    |   21.42 |        0 |       0 |   21.42 | 15-41                                                                                                                             
  uploadValidation.js                                |      20 |        0 |       0 |      20 | 15-61                                                                                                                             
 src/migrations                                      |       0 |      100 |       0 |       0 |                                                                                                                                   
  20240101000001-create-episodes.js                  |       0 |      100 |       0 |       0 | 3-125                                                                                                                             
  20240101000002-create-metadata-storage.js          |       0 |      100 |       0 |       0 | 3-67                                                                                                                              
  20240101000003-create-thumbnails.js                |       0 |      100 |       0 |       0 | 3-87                                                                                                                              
  20240101000004-create-processing-queue.js          |       0 |      100 |       0 |       0 | 3-92                                                                                                                              
  20240101000005-create-activity-logs.js             |       0 |      100 |       0 |       0 | 3-73                                                                                                                              
  20260104000001-add-justawomaninherprime-support.js |       0 |      100 |       0 |       0 | 11-77                                                                                                                             
  20260104000002-update-composition-workflow.js      |       0 |      100 |       0 |       0 | 10-75                                                                                                                             
 src/models                                          |   45.23 |        0 |   18.36 |   46.06 |                                                                                                                                   
  ActivityLog.js                                     |    37.5 |        0 |   16.66 |   42.85 | 117,133,144,154-164,174-189                                                                                                       
  Asset.js                                           |     100 |      100 |     100 |     100 |                                                                                                                                   
  Episode.js                                         |   46.42 |        0 |      10 |   46.42 | 217-218,225-226,233-237,244,262,269,279,288-291,298                                                                               
  FileStorage.js                                     |   71.42 |      100 |      50 |   71.42 | 130-135                                                                                                                           
  MetadataStorage.js                                 |      36 |        0 |   16.66 |      36 | 106-108,115-117,124-127,138,147-160                                                                                               
  ProcessingQueue.js                                 |   35.55 |        0 |    7.69 |   35.55 | 137-139,146-148,155-158,165-173,180,187-190,201,213,224,234,247,257-267                                                           
  Thumbnail.js                                       |   44.44 |        0 |   11.11 |   44.44 | 190-191,198-201,208-212,223,235,248,261-273,280                                                                                   
  ThumbnailComposition.js                            |     100 |      100 |     100 |     100 |                                                                                                                                   
  ThumbnailTemplate.js                               |     100 |      100 |     100 |     100 |                                                                                                                                   
 src/routes                                          |   24.87 |     0.38 |       0 |   25.54 |                                                                                                                                   
  assets.js                                          |   20.93 |     4.16 |       0 |   20.93 | 38-42,52-72,84-94,106-122,134-166,178-195,207-226,238-275                                                                         
  auth.js                                            |    20.4 |        0 |       0 |    20.4 | 17-74,87-111,125-150,163-173,186-215                                                                                              
  compositions.js                                    |    1.32 |        0 |       0 |    1.32 | 17-1004                                                                                                                           
  episodes.js                                        |     100 |      100 |     100 |     100 |                                                                                                                                   
  files.js                                           |   79.16 |      100 |       0 |     100 |                                                                                                                                   
  jobs.js                                            |   66.66 |      100 |       0 |     100 |                                                                                                                                   
  metadata.js                                        |     100 |      100 |     100 |     100 |                                                                                                                                   
  processing.js                                      |     100 |      100 |     100 |     100 |                                                                                                                                   
  search.js                                          |   71.42 |      100 |       0 |     100 |                                                                                                                                   
  seed.js                                            |   41.17 |        0 |       0 |   41.17 | 92-120                                                                                                                            
  templates.js                                       |   35.29 |        0 |       0 |   35.29 | 17-27,39-49                                                                                                                       
  thumbnails.js                                      |      50 |        0 |       0 |      50 | 96-105,117-125,137-145,156-164                                                                                                    
 src/services                                        |   30.38 |    18.23 |   35.84 |   30.59 |                                                                                                                                   
  AssetService.js                                    |   12.32 |      3.7 |       0 |   12.85 | 15-25,35-230                                                                                                                      
  CompositionService.js                              |    3.57 |        0 |       0 |    3.75 | 16-392                                                                                                                            
  FileValidationService.js                           |     100 |    97.22 |     100 |     100 | 141                                                                                                                               
  FilterService.js                                   |       0 |        0 |       0 |       0 | 3-352                                                                                                                             
  JobQueueService.js                                 |   96.36 |    66.66 |   91.66 |   98.11 | 95                                                                                                                                
  OpenSearchService.js                               |   71.91 |     60.6 |   83.33 |   71.59 | 37-93,105-106,135-136,166-167,194-195,323-332                                                                                     
  RunwayMLService.js                                 |   17.94 |        0 |   16.66 |   17.94 | 21-129                                                                                                                            
  S3Service.js                                       |   95.83 |    66.66 |     100 |   95.74 | 155-160                                                                                                                           
  ThumbnailGeneratorService.js                       |    7.14 |        0 |       0 |    7.27 | 52-350                                                                                                                            
  ThumbnailService.js                                |       0 |        0 |       0 |       0 | 1-174                                                                                                                             
  VersioningService.js                               |    2.22 |        0 |       0 |    2.22 | 16-300                                                                                                                            
  tokenService.js                                    |    9.37 |        0 |       0 |    9.37 | 17-144                                                                                                                            
 src/utils                                           |   41.66 |    21.42 |      25 |   41.66 |                                                                                                                                   
  logger.js                                          |   41.66 |    21.42 |      25 |   41.66 | 17-18,24-36                                                                                                                       
-----------------------------------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (75%) not met: 46.11%
Jest: "global" coverage threshold for branches (75%) not met: 32.87%
Jest: "global" coverage threshold for lines (75%) not met: 46.61%
Jest: "global" coverage threshold for functions (75%) not met: 39.45%

Summary of all failing tests
FAIL tests/unit/controllers/metadata.test.js
  ΓùÅ Metadata Controller ΓÇ║ Error Handling ΓÇ║ should handle database errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500

    Number of calls: 0

      288 |       await metadataController.listMetadata(mockReq, mockRes);
      289 |
    > 290 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      291 |     });
      292 |   });
      293 | });

      at Object.toHaveBeenCalledWith (tests/unit/controllers/metadata.test.js:290:30)


Test Suites: 1 failed, 21 passed, 22 total
Tests:       1 failed, 6 skipped, 750 passed, 757 total
Snapshots:   0 total
Time:        6.905 s
Ran all test suites.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
