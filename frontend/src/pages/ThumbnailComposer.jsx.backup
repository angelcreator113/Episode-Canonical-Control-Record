import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import './ThumbnailComposer.css';
import { mockEpisodes, mockAssets } from '../mocks/mockEpisodes';
import AssetRolePicker from '../components/AssetRolePicker';

/**
 * ThumbnailComposer Component
 * Create compositions and generate thumbnails for multiple formats
 */

function ThumbnailComposer() {
  const { episodeId: paramEpisodeId } = useParams();
  const navigate = useNavigate();
  
  // Multi-step form state (6 steps: Show ‚Üí Episode ‚Üí Template ‚Üí Assets ‚Üí Formats ‚Üí Review)
  const [currentStep, setCurrentStep] = useState(1);
  const totalSteps = 6;
  
  // Show selection state
  const [selectedShowId, setSelectedShowId] = useState('');
  const [selectedShowName, setSelectedShowName] = useState('');
  const [shows, setShows] = useState([]);
  
  // Episode selection state
  const [episodeId, setEpisodeId] = useState(paramEpisodeId || '');
  const [episodeName, setEpisodeName] = useState('');
  const [episodes, setEpisodes] = useState([]);
  
  // Template selection state
  const [selectedTemplateId, setSelectedTemplateId] = useState('');
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [templates, setTemplates] = useState([]);
  
  // Role-based asset selection (object mapping role -> assetId)
  const [selectedAssets, setSelectedAssets] = useState({});
  
  // Role-based asset lists (object mapping role -> array of assets)
  const [assetsByRole, setAssetsByRole] = useState({});
  
  // NEW: Composition configuration
  const [visibilityToggles, setVisibilityToggles] = useState({});
  const [textFieldValues, setTextFieldValues] = useState({});
  
  // Legacy asset IDs (kept for backwards compatibility)
  const [lalaAssetId, setLalaAssetId] = useState('');
  const [guestAssetId, setGuestAssetId] = useState('');
  const [justawomanAssetId, setJustawomanAssetId] = useState('');
  const [backgroundFrameAssetId, setBackgroundFrameAssetId] = useState('');
  
  // Asset lists (legacy, kept for backwards compatibility)
  const [lalaAssets, setLalaAssets] = useState([]);
  const [guestAssets, setGuestAssets] = useState([]);
  const [justawomanAssets, setJustawomanAssets] = useState([]);
  const [backgroundFrameAssets, setBackgroundFrameAssets] = useState([]);
  
  const [selectedFormats, setSelectedFormats] = useState({
    YOUTUBE: true,
    YOUTUBE_MOBILE: false,
    INSTAGRAM_FEED: false,
    INSTAGRAM_STORY: false,
    TIKTOK: false,
    FACEBOOK: false,
    TWITTER: false,
    PINTEREST: false
  });

  const [status, setStatus] = useState('');
  const [loading, setLoading] = useState(false);
  const [compositions, setCompositions] = useState([]);
  const [showGallery, setShowGallery] = useState(false);
  const [thumbnails, setThumbnails] = useState({});
  
  // Asset refresh key - increment to force re-fetch of assets
  const [assetRefreshKey, setAssetRefreshKey] = useState(0);

  // Auto-refresh assets when window gains focus (user might have uploaded in another tab)
  useEffect(() => {
    const handleFocus = () => {
      setAssetRefreshKey(prev => prev + 1);
    };
    
    window.addEventListener('focus', handleFocus);
    return () => window.removeEventListener('focus', handleFocus);
  }, []);

  // Load data on mount
  useEffect(() => {
    const savedEpisodeId = localStorage.getItem('selectedEpisodeId');
    if (savedEpisodeId && !paramEpisodeId) {
      setEpisodeId(savedEpisodeId);
    }
    
    const savedShowId = localStorage.getItem('selectedShowId');
    if (savedShowId) {
      setSelectedShowId(savedShowId);
    }
    
    // Always load shows first
    loadShows();
    
    if (paramEpisodeId) {
      loadSingleEpisode(paramEpisodeId);
    }
    
    // Legacy asset loading (kept for backwards compatibility)
    loadLalaAssets();
    loadGuestAssets();
    loadJustawomanAssets();
    loadBackgroundFrameAssets();
  }, [paramEpisodeId]);

  // Load assets when template is selected
  useEffect(() => {
    if (selectedTemplate?.required_roles) {
      loadAssetsByRoles(selectedTemplate.required_roles);
      
      // Initialize visibility toggles from template defaults
      const defaultVisibility = {};
      if (selectedTemplate.optional_roles) {
        selectedTemplate.optional_roles.forEach(role => {
          // Auto-enable icons by default for now (can be template-specific later)
          defaultVisibility[role] = false;
        });
      }
      setVisibilityToggles(defaultVisibility);
      
      // Initialize required text fields
      const defaultText = {};
      if (episodeName) {
        defaultText['TEXT.SHOW.TITLE'] = episodeName.split(' - ')[0] || episodeName; // Extract show name
      }
      setTextFieldValues(defaultText);
    }
  }, [selectedTemplate, episodeName]);

  // Load episodes when show changes
  useEffect(() => {
    if (selectedShowId) {
      loadEpisodes(selectedShowId);
      loadTemplates(selectedShowId);
      localStorage.setItem('selectedShowId', selectedShowId);
    }
  }, [selectedShowId]);

  // Save episode selection
  useEffect(() => {
    if (episodeId && episodeId !== 'default') {
      localStorage.setItem('selectedEpisodeId', episodeId);
      localStorage.setItem('selectedEpisodeName', episodeName);
    }
  }, [episodeId, episodeName]);

  // Load compositions when episode changes
  useEffect(() => {
    if (episodeId && episodeId !== 'default') {
      loadCompositions();
    }
  }, [episodeId]);

  // Load saved compositions from localStorage
  useEffect(() => {
    try {
      const savedCompositions = localStorage.getItem('compositions');
      if (savedCompositions) {
        const parsed = JSON.parse(savedCompositions);
        if (Array.isArray(parsed) && parsed.length > 0) {
          setCompositions(parsed);
        }
      }
    } catch (e) {
      console.error('Failed to load saved compositions:', e);
    }
  }, []);

  // Save compositions to localStorage
  useEffect(() => {
    if (compositions.length > 0) {
      localStorage.setItem('compositions', JSON.stringify(compositions));
    }
  }, [compositions]);

  // Load shows
  const loadShows = async () => {
    try {
      const response = await fetch('/api/v1/shows');
      const data = await response.json();
      
      let showList = [];
      if (data.data && Array.isArray(data.data)) {
        showList = data.data;
      } else if (Array.isArray(data)) {
        showList = data;
      }
      
      setShows(showList);
      
      // Auto-select if only one show
      if (showList.length === 1) {
        setSelectedShowId(showList[0].id);
        setSelectedShowName(showList[0].name);
      }
    } catch (error) {
      console.error('Failed to load shows:', error);
      setShows([]);
    }
  };

  // Load episodes filtered by show
  const loadEpisodes = async (showId = selectedShowId) => {
    try {
      const url = showId ? `/api/v1/episodes?show_id=${showId}` : '/api/v1/episodes';
      const response = await fetch(url);
      const data = await response.json();
      
      let episodeList = [];
      if (data.data && Array.isArray(data.data)) {
        episodeList = data.data;
      } else if (Array.isArray(data)) {
        episodeList = data;
      } else if (data.episodes && Array.isArray(data.episodes)) {
        episodeList = data.episodes;
      }
      
      setEpisodes(episodeList.length > 0 ? episodeList : mockEpisodes);
    } catch (error) {
      setEpisodes(mockEpisodes);
    }
  };

  const loadSingleEpisode = async (id) => {
    try {
      if (id === 'default') {
        const response = await fetch('/api/v1/episodes?limit=1');
        const data = await response.json();
        if (data.data && data.data.length > 0) {
          const episode = data.data[0];
          setEpisodeId(episode.id);
          setEpisodeName(episode.title || `Episode ${episode.episode_number}`);
          return;
        }
        
        const episode = mockEpisodes[0];
        if (episode) {
          setEpisodeId(episode.id);
          setEpisodeName(episode.episodeTitle || `Episode ${episode.episodeNumber}`);
        }
      } else {
        const response = await fetch(`/api/v1/episodes/${id}`);
        if (response.ok) {
          const data = await response.json();
          const episode = data.data;
          if (episode) {
            setEpisodeId(episode.id);
            setEpisodeName(episode.title || `Episode ${episode.episode_number}`);
            return;
          }
        }
        
        const episode = mockEpisodes.find(e => e.id === id) || mockEpisodes[0];
        if (episode) {
          setEpisodeId(episode.id);
          setEpisodeName(episode.episodeTitle || `Episode ${episode.episodeNumber}`);
        }
      }
    } catch (error) {
      const episode = mockEpisodes[0];
      if (episode) {
        setEpisodeId(episode.id);
        setEpisodeName(episode.episodeTitle || `Episode ${episode.episodeNumber}`);
      }
    }
  };

  const loadLalaAssets = async () => {
    try {
      const response = await fetch('/api/v1/assets/approved/PROMO_LALA');
      if (response.ok) {
        const data = await response.json();
        const assets = data.data || data.assets || [];
        setLalaAssets(assets);
        if (assets.length > 0) setLalaAssetId(assets[0].id);
      } else {
        throw new Error('Failed to load');
      }
    } catch (error) {
      setLalaAssets(mockAssets.PROMO_LALA);
      if (mockAssets.PROMO_LALA.length > 0) {
        setLalaAssetId(mockAssets.PROMO_LALA[0].id);
      }
    }
  };

  const loadGuestAssets = async () => {
    try {
      const response = await fetch('/api/v1/assets/approved/PROMO_GUEST');
      if (response.ok) {
        const data = await response.json();
        setGuestAssets(data.data || data.assets || []);
      } else {
        throw new Error('Failed to load');
      }
    } catch (error) {
      setGuestAssets(mockAssets.PROMO_GUEST);
    }
  };

  const loadJustawomanAssets = async () => {
    try {
      const response = await fetch('/api/v1/assets/approved/PROMO_JUSTAWOMANINHERPRIME');
      if (response.ok) {
        const data = await response.json();
        const assets = data.data || data.assets || [];
        setJustawomanAssets(assets);
        if (assets.length > 0) setJustawomanAssetId(assets[0].id);
      } else {
        throw new Error('Failed to load');
      }
    } catch (error) {
      setJustawomanAssets(mockAssets.PROMO_JUSTAWOMANINHERPRIME);
      if (mockAssets.PROMO_JUSTAWOMANINHERPRIME.length > 0) {
        setJustawomanAssetId(mockAssets.PROMO_JUSTAWOMANINHERPRIME[0].id);
      }
    }
  };

  const loadBackgroundFrameAssets = async () => {
    try {
      const response = await fetch('/api/v1/assets/approved/EPISODE_FRAME');
      if (response.ok) {
        const data = await response.json();
        const assets = data.data || data.assets || [];
        setBackgroundFrameAssets(assets);
        if (assets.length > 0) setBackgroundFrameAssetId(assets[0].id);
      } else {
        throw new Error('Failed to load');
      }
    } catch (error) {
      setBackgroundFrameAssets(mockAssets.EPISODE_FRAME);
      if (mockAssets.EPISODE_FRAME.length > 0) {
        setBackgroundFrameAssetId(mockAssets.EPISODE_FRAME[0].id);
      }
    }
  };

  // Load assets dynamically based on template's required roles
  const loadAssetsByRoles = async (roles) => {
    try {
      const roleAssets = {};
      
      // Load assets for each required role
      for (const role of roles) {
        try {
          const response = await fetch(`/api/v1/assets?asset_role=${encodeURIComponent(role)}`);
          if (response.ok) {
            const data = await response.json();
            const assets = data.data || data.assets || [];
            roleAssets[role] = assets;
            
            // Auto-select first asset if none selected for this role
            if (assets.length > 0 && !selectedAssets[role]) {
              setSelectedAssets(prev => ({
                ...prev,
                [role]: assets[0].id
              }));
            }
          } else {
            console.error(`Failed to load assets for role: ${role}`);
            roleAssets[role] = [];
          }
        } catch (error) {
          console.error(`Error loading assets for role ${role}:`, error);
          roleAssets[role] = [];
        }
      }
      
      setAssetsByRole(roleAssets);
    } catch (error) {
      console.error('Error loading assets by roles:', error);
      setAssetsByRole({});
    }
  };

  // Load templates filtered by show
  const loadTemplates = async (showId = selectedShowId) => {
    try {
      const url = showId 
        ? `/api/v1/thumbnail-templates?showId=${showId}` 
        : '/api/v1/thumbnail-templates';
      const response = await fetch(url);
      const data = await response.json();
      
      let templateList = [];
      if (data.data && Array.isArray(data.data)) {
        templateList = data.data;
      } else if (Array.isArray(data)) {
        templateList = data;
      }
      
      setTemplates(templateList);
      
      // Auto-select active template
      const activeTemplate = templateList.find(t => t.is_active);
      if (activeTemplate && !selectedTemplateId) {
        setSelectedTemplateId(activeTemplate.id);
        setSelectedTemplate(activeTemplate);
      }
    } catch (error) {
      console.error('Failed to load templates:', error);
      setTemplates([]);
    }
  };

  const loadCompositions = async () => {
    try {
      if (!episodeId || episodeId === 'default') return;

      const response = await fetch(`/api/v1/compositions/episode/${episodeId}`);
      if (response.ok) {
        const data = await response.json();
        setCompositions(data.data || []);
      }
    } catch (error) {
      console.error('Failed to load compositions:', error);
    }
  };

  // Navigation functions
  // Navigation functions
  const canProceedToStep = (step) => {
    switch(step) {
      case 1:
        return true; // Can always access step 1 (Show Selection)
      case 2:
        return selectedShowId !== ''; // Episode Selection requires show
      case 3:
        return selectedShowId && episodeId && episodeId !== 'default'; // Template requires show + episode
      case 4:
        return selectedShowId && episodeId && selectedTemplateId; // Assets require template
      case 5:
        // Formats require all required assets from template to be selected
        if (!selectedTemplate || !selectedTemplate.required_roles) return false;
        const requiredRoles = selectedTemplate.required_roles;
        const allRequiredSelected = requiredRoles.every(role => selectedAssets[role]);
        return allRequiredSelected;
      case 6:
        // Review requires formats selected
        if (!selectedTemplate || !selectedTemplate.required_roles) return false;
        const requiredRolesForReview = selectedTemplate.required_roles;
        const allRequiredSelectedForReview = requiredRolesForReview.every(role => selectedAssets[role]);
        return allRequiredSelectedForReview && Object.values(selectedFormats).some(v => v);
      default:
        return false;
    }
  };

  const nextStep = () => {
    if (currentStep < totalSteps && canProceedToStep(currentStep + 1)) {
      setCurrentStep(currentStep + 1);
    }
  };

  const prevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const goToStep = (step) => {
    if (step >= 1 && step <= totalSteps && canProceedToStep(step)) {
      setCurrentStep(step);
    }
  };

  const handleFormatToggle = (format) => {
    setSelectedFormats(prev => ({
      ...prev,
      [format]: !prev[format]
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const formats = Object.keys(selectedFormats).filter(key => selectedFormats[key]);
    
    // Validation
    if (!episodeId || episodeId === 'default' || episodeId === '') {
      setStatus('‚ùå Please select a valid episode');
      return;
    }
    
    if (!selectedTemplateId) {
      setStatus('‚ùå Please select a template');
      return;
    }

    // Validate all required assets are selected
    if (selectedTemplate && selectedTemplate.required_roles) {
      const missingRoles = selectedTemplate.required_roles.filter(role => !selectedAssets[role]);
      if (missingRoles.length > 0) {
        setStatus(`‚ùå Missing required assets: ${missingRoles.join(', ')}`);
        return;
      }
    }
    
    // Validate required text fields
    if (!textFieldValues['TEXT.SHOW.TITLE'] || textFieldValues['TEXT.SHOW.TITLE'].trim() === '') {
      setStatus('‚ùå Show title is required');
      return;
    }
    
    // Check icon holder requirement
    const anyIconEnabled = Object.entries(visibilityToggles).some(
      ([role, visible]) => visible && role.includes('.ICON.') && role !== 'UI.ICON.HOLDER.MAIN'
    );
    if (anyIconEnabled && !selectedAssets['UI.ICON.HOLDER.MAIN']) {
      setStatus('‚ùå Icon holder asset is required when icons are visible');
      return;
    }
    
    // Validate enabled optional roles have assets assigned
    const enabledOptionalRoles = Object.entries(visibilityToggles)
      .filter(([role, visible]) => visible && !role.startsWith('TEXT.'))
      .map(([role]) => role);
    const missingOptionalAssets = enabledOptionalRoles.filter(role => !selectedAssets[role]);
    if (missingOptionalAssets.length > 0) {
      setStatus(`‚ùå Missing assets for enabled roles: ${missingOptionalAssets.join(', ')}`);
      return;
    }
    
    // Guest metadata validation (blocking on save)
    const guestRolesEnabled = Object.entries(visibilityToggles)
      .filter(([role, visible]) => visible && role.startsWith('CHAR.GUEST.'))
      .map(([role]) => role);
    
    if (guestRolesEnabled.length > 0) {
      const selectedEp = episodes.find(ep => ep.id === episodeId);
      const guests = selectedEp?.metadata?.guests || [];
      
      if (guestRolesEnabled.includes('CHAR.GUEST.1') && !guests[0]) {
        setStatus('‚ùå Guest 1 metadata is missing in episode. Please add guest information to the episode first.');
        return;
      }
      if (guestRolesEnabled.includes('CHAR.GUEST.2') && !guests[1]) {
        setStatus('‚ùå Guest 2 metadata is missing in episode. Please add guest information to the episode first.');
        return;
      }
    }
    
    if (formats.length === 0) {
      setStatus('‚ùå Please select at least one format');
      return;
    }

    setStatus('‚è≥ Creating composition and generating thumbnails...');
    setLoading(true);

    try {
      // Build composition_config
      const composition_config = {
        visibility: visibilityToggles,
        text_fields: textFieldValues,
        overrides: {}
      };
      
      // Use new role-based format
      const response = await fetch('/api/v1/compositions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          episode_id: episodeId,
          template_id: selectedTemplateId,
          assets: selectedAssets, // Send role-based assets object
          selected_formats: formats,
          composition_config
        })
      });

      const data = await response.json();
      
      if (response.ok) {
        const composition = data.data || data;
        setStatus(`‚úÖ Composition created! Redirecting...`);
        
        // Redirect to composition detail page
        setTimeout(() => {
          window.location.href = `/compositions/${composition.id}`;
        }, 1000);
      } else {
        const errorMsg = data.error || data.message || 'Failed to create composition';
        throw new Error(errorMsg);
      }
    } catch (error) {
      setStatus(`‚ùå Error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handleGenerateThumbnails = async (composition) => {
    try {
      setLoading(true);
      const episodeName = composition.episodeName || composition.episode?.episodeTitle || 'Unknown Episode';
      setStatus(`‚è≥ Generating thumbnails: ${episodeName}...`);
      
      const response = await fetch(`/api/v1/compositions/${composition.id}/generate-thumbnails`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();

      if (response.ok && data.thumbnails) {
        setThumbnails(prev => ({
          ...prev,
          [composition.id]: data.thumbnails
        }));
        setStatus(`‚úÖ Generated ${data.thumbnails.length} thumbnails: ${episodeName}`);
      } else if (response.ok) {
        setStatus(`‚úÖ Thumbnails generated: ${episodeName}`);
      } else {
        const errorMsg = data?.message || data?.error || 'Unknown error';
        setStatus(`‚ùå Failed to generate: ${errorMsg}`);
      }
    } catch (error) {
      setStatus(`‚ö†Ô∏è Generation failed: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteComposition = async (composition) => {
    const episodeName = composition.episodeName || composition.episode?.episodeTitle || 'Unknown Episode';
    if (!window.confirm(`üóëÔ∏è Delete composition: ${episodeName}?\n\nThis cannot be undone.`)) {
      return;
    }

    try {
      setLoading(true);
      setStatus(`‚è≥ Deleting: ${episodeName}...`);
      
      const response = await fetch(`/api/v1/compositions/${composition.id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok || response.status === 404 || response.status === 401 || response.status === 403) {
        setCompositions(prev => prev.filter(c => c.id !== composition.id));
        setStatus(`‚úÖ Deleted: ${episodeName}`);
      } else {
        const data = await response.json();
        const errorMsg = data?.message || data?.error || 'Unknown error';
        setStatus(`‚ùå Failed to delete: ${errorMsg}`);
      }
    } catch (error) {
      setStatus(`‚ö†Ô∏è Delete failed: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const getFormatLabel = (format) => {
    const labels = {
      YOUTUBE: 'YouTube',
      YOUTUBE_MOBILE: 'YouTube Mobile',
      INSTAGRAM_FEED: 'Instagram Feed',
      INSTAGRAM_STORY: 'Instagram Story',
      TIKTOK: 'TikTok',
      FACEBOOK: 'Facebook',
      TWITTER: 'Twitter',
      PINTEREST: 'Pinterest'
    };
    return labels[format] || format;
  };

  const getFormatDimensions = (format) => {
    const dimensions = {
      YOUTUBE: '1920√ó1080',
      YOUTUBE_MOBILE: '1280√ó720',
      INSTAGRAM_FEED: '1080√ó1080',
      INSTAGRAM_STORY: '1080√ó1920',
      TIKTOK: '1080√ó1920',
      FACEBOOK: '1200√ó630',
      TWITTER: '1200√ó675',
      PINTEREST: '1000√ó1500'
    };
    return dimensions[format] || '';
  };

  const selectedCount = Object.values(selectedFormats).filter(Boolean).length;

  // Workflow step states
  const isEpisodeSelected = !!episodeId && episodeId !== 'default';
  const areAssetsSelected = !!(lalaAssetId && justawomanAssetId && backgroundFrameAssetId);
  const areFormatsSelected = selectedCount > 0;

  return (
    <div className="thumbnail-composer">
      {/* Header */}
      <div className="composer-header">
        <div className="composer-header-content">
          <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
            <button onClick={() => navigate(-1)} className="btn-secondary" style={{ padding: '0.5rem 0.75rem', fontSize: '0.875rem' }}>
              ‚Üê Back
            </button>
            <div className="composer-title">
              <h1>üé® Thumbnail Composer</h1>
              <p className="subtitle">Step-by-step thumbnail creation wizard</p>
            </div>
          </div>
          <button 
            onClick={() => setShowGallery(!showGallery)}
            style={{
              padding: '0.75rem 1.5rem',
              background: showGallery ? '#6b7280' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              fontWeight: '600',
              fontSize: '0.95rem',
              cursor: 'pointer',
              boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
              transition: 'all 0.2s'
            }}
          >
            {showGallery ? '‚úèÔ∏è Back to Wizard' : 'üñºÔ∏è View Compositions'}
          </button>
        </div>
      </div>

      {/* Body */}
      <div className="composer-body">
        {!showGallery ? (
          <>
            {/* Progress Bar */}
            <div style={{ marginBottom: '2rem' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                <span style={{ fontSize: '0.875rem', fontWeight: '600', color: '#6b7280' }}>
                  Step {currentStep} of {totalSteps}
                </span>
                <span style={{ fontSize: '0.875rem', fontWeight: '600', color: '#667eea' }}>
                  {Math.round((currentStep / totalSteps) * 100)}% Complete
                </span>
              </div>
              <div style={{ height: '8px', background: '#e5e7eb', borderRadius: '999px', overflow: 'hidden' }}>
                <div style={{
                  height: '100%',
                  width: `${(currentStep / totalSteps) * 100}%`,
                  background: 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)',
                  transition: 'width 0.3s ease',
                  borderRadius: '999px'
                }}></div>
              </div>
            </div>

            {/* Step Indicators */}
            <div style={{ display: 'flex', justifyContent: 'center', gap: '0.75rem', marginBottom: '2rem', flexWrap: 'wrap' }}>
              {[
                { num: 1, label: 'üì∫ Show', desc: 'Select show' },
                { num: 2, label: 'üé¨ Episode', desc: 'Pick episode' },
                { num: 3, label: 'üìã Template', desc: 'Choose layout' },
                { num: 4, label: 'üñºÔ∏è Assets', desc: 'Add images' },
                { num: 5, label: 'üì± Formats', desc: 'Select sizes' },
                { num: 6, label: '‚ú® Review', desc: 'Generate' }
              ].map(step => (
                <button
                  key={step.num}
                  onClick={() => goToStep(step.num)}
                  disabled={!canProceedToStep(step.num)}
                  style={{
                    flex: '1 1 200px',
                    maxWidth: '220px',
                    padding: '1rem',
                    background: currentStep === step.num 
                      ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                      : canProceedToStep(step.num) && currentStep > step.num
                      ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                      : '#f3f4f6',
                    color: currentStep === step.num || (canProceedToStep(step.num) && currentStep > step.num) ? 'white' : '#9ca3af',
                    border: 'none',
                    borderRadius: '12px',
                    cursor: canProceedToStep(step.num) ? 'pointer' : 'not-allowed',
                    textAlign: 'center',
                    boxShadow: currentStep === step.num ? '0 4px 12px rgba(102, 126, 234, 0.3)' : 'none',
                    transition: 'all 0.2s',
                    opacity: canProceedToStep(step.num) ? 1 : 0.5
                  }}
                >
                  <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>
                    {currentStep > step.num && canProceedToStep(step.num + 1) ? '‚úÖ' : step.label.split(' ')[0]}
                  </div>
                  <div style={{ fontSize: '0.875rem', fontWeight: '700', marginBottom: '0.25rem' }}>
                    {step.label.split(' ').slice(1).join(' ')}
                  </div>
                  <div style={{ fontSize: '0.75rem', opacity: 0.9 }}>
                    {step.desc}
                  </div>
                </button>
              ))}
            </div>

            {/* Status Message */}
            {status && (
              <div style={{
                padding: '1rem 1.5rem',
                background: status.includes('‚úÖ') ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)',
                border: `2px solid ${status.includes('‚úÖ') ? '#10b981' : '#ef4444'}`,
                borderRadius: '12px',
                marginBottom: '2rem',
                fontSize: '1rem',
                fontWeight: '600',
                color: status.includes('‚úÖ') ? '#065f46' : '#991b1b',
                textAlign: 'center'
              }}>
                {status}
              </div>
            )}

            {/* Step Content */}
            <div style={{
              background: 'white',
              padding: '2.5rem',
              borderRadius: '16px',
              boxShadow: '0 4px 16px rgba(0,0,0,0.08)',
              minHeight: '500px'
            }}>
              {/* STEP 1: Select Show */}
              {currentStep === 1 && (
                <div>
                  <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üé¨</div>
                    <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                      Choose Your Show
                    </h2>
                    <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                      Select which show you want to work with
                    </p>
                  </div>

                  {shows.length === 0 ? (
                    <div style={{
                      maxWidth: '600px',
                      margin: '0 auto',
                      padding: '2rem',
                      background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                      border: '2px solid #f59e0b',
                      borderRadius: '12px',
                      textAlign: 'center'
                    }}>
                      <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>‚ö†Ô∏è</div>
                      <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.5rem', fontWeight: '700', color: '#92400e' }}>
                        No Shows Available
                      </h3>
                      <p style={{ margin: 0, fontSize: '1.1rem', color: '#78350f' }}>
                        Please create a show first before creating thumbnails
                      </p>
                    </div>
                  ) : (
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                      gap: '1.5rem',
                      maxWidth: '1200px',
                      margin: '0 auto'
                    }}>
                      {shows.map(show => (
                        <div
                          key={show.id}
                          onClick={() => {
                            setSelectedShowId(show.id);
                            setSelectedShowName(show.name || show.title || 'Untitled Show');
                          }}
                          style={{
                            padding: '1.5rem',
                            background: selectedShowId === show.id 
                              ? 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' 
                              : 'white',
                            border: selectedShowId === show.id 
                              ? '3px solid #3b82f6' 
                              : '2px solid #e5e7eb',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            boxShadow: selectedShowId === show.id 
                              ? '0 8px 16px rgba(59, 130, 246, 0.2)' 
                              : '0 2px 4px rgba(0,0,0,0.05)'
                          }}
                          onMouseEnter={(e) => {
                            if (selectedShowId !== show.id) {
                              e.currentTarget.style.transform = 'translateY(-4px)';
                              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            if (selectedShowId !== show.id) {
                              e.currentTarget.style.transform = 'translateY(0)';
                              e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                            }
                          }}
                        >
                          <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem' }}>
                            <div style={{ fontSize: '2.5rem', marginRight: '1rem' }}>
                              {show.icon || 'üé¨'}
                            </div>
                            <div style={{ flex: 1 }}>
                              <h3 style={{
                                margin: '0 0 0.25rem 0',
                                fontSize: '1.25rem',
                                fontWeight: '700',
                                color: selectedShowId === show.id ? '#1e40af' : '#1f2937'
                              }}>
                                {show.name || show.title || 'Untitled Show'}
                              </h3>
                              {selectedShowId === show.id && (
                                <div style={{
                                  display: 'inline-block',
                                  padding: '0.25rem 0.75rem',
                                  background: '#3b82f6',
                                  color: 'white',
                                  borderRadius: '12px',
                                  fontSize: '0.75rem',
                                  fontWeight: '600'
                                }}>
                                  SELECTED
                                </div>
                              )}
                            </div>
                          </div>
                          {show.description && (
                            <p style={{
                              margin: '0 0 1rem 0',
                              fontSize: '0.95rem',
                              color: '#6b7280',
                              lineHeight: '1.5'
                            }}>
                              {show.description}
                            </p>
                          )}
                          <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            fontSize: '0.875rem',
                            color: '#6b7280',
                            borderTop: '1px solid #e5e7eb',
                            paddingTop: '1rem'
                          }}>
                            <span>üì∫ {show.episode_count || 0} Episodes</span>
                            {show.is_active && (
                              <span style={{ color: '#10b981', fontWeight: '600' }}>‚óè Active</span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* STEP 2: Select Episode */}
              {currentStep === 2 && (
                <div>
                  {/* Show Context Banner */}
                  {selectedShowName && (
                    <div style={{
                      maxWidth: '800px',
                      margin: '0 auto 2rem auto',
                      padding: '1rem 1.5rem',
                      background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
                      border: '2px solid #3b82f6',
                      borderRadius: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '0.75rem'
                    }}>
                      <span style={{ fontSize: '1.5rem' }}>üé¨</span>
                      <span style={{ fontSize: '1.1rem', fontWeight: '600', color: '#1e40af' }}>
                        Selecting episode for: {selectedShowName}
                      </span>
                    </div>
                  )}

                  <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üì∫</div>
                    <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                      Choose Your Episode
                    </h2>
                    <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                      Select which episode you want to create thumbnails for
                    </p>
                  </div>

                  {paramEpisodeId && paramEpisodeId !== 'default' ? (
                    <div style={{
                      maxWidth: '600px',
                      margin: '0 auto',
                      padding: '2rem',
                      background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
                      border: '2px solid #3b82f6',
                      borderRadius: '12px',
                      textAlign: 'center'
                    }}>
                      <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>‚úÖ</div>
                      <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.5rem', fontWeight: '700', color: '#1e3a8a' }}>
                        Episode Pre-Selected
                      </h3>
                      <p style={{ margin: 0, fontSize: '1.1rem', color: '#1e40af' }}>
                        {episodeName || `Episode ID: ${paramEpisodeId.substring(0, 12)}...`}
                      </p>
                    </div>
                  ) : (
                    <div style={{ maxWidth: '600px', margin: '0 auto' }}>
                      <label style={{
                        display: 'block',
                        fontSize: '1rem',
                        fontWeight: '600',
                        color: '#374151',
                        marginBottom: '0.75rem'
                      }}>
                        Select Episode <span style={{ color: '#ef4444' }}>*</span>
                      </label>
                      <select
                        value={episodeId}
                        onChange={(e) => {
                          setEpisodeId(e.target.value);
                          const selected = episodes.find(ep => ep.id === e.target.value);
                          if (selected) {
                            setEpisodeName(selected.title || selected.episodeTitle || `Episode ${selected.episode_number}`);
                          }
                        }}
                        style={{
                          width: '100%',
                          padding: '1rem 1.25rem',
                          fontSize: '1.1rem',
                          border: '2px solid #d1d5db',
                          borderRadius: '10px',
                          background: 'white',
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                          marginBottom: '1rem'
                        }}
                      >
                        <option value="">-- Choose an Episode --</option>
                        {episodes.map(ep => (
                          <option key={ep.id} value={ep.id}>
                            {ep.episode_number ? `Episode ${ep.episode_number}` : ''} - {ep.title || ep.episodeTitle || 'Untitled'}
                          </option>
                        ))}
                      </select>
                      
                      {episodes.length === 0 && (
                        <div style={{
                          padding: '1.5rem',
                          background: '#fef3c7',
                          border: '2px solid #f59e0b',
                          borderRadius: '8px',
                          marginTop: '1rem'
                        }}>
                          <p style={{ margin: 0, color: '#92400e', fontSize: '0.95rem' }}>
                            ‚ö†Ô∏è No episodes available for this show. Please create an episode first.
                          </p>
                        </div>
                      )}

                      {episodes.length > 0 && (
                        <div style={{
                          padding: '1.5rem',
                          background: '#d1fae5',
                          border: '2px solid #10b981',
                          borderRadius: '8px',
                          marginTop: '1rem'
                        }}>
                          <p style={{ margin: 0, color: '#065f46', fontSize: '0.95rem' }}>
                            ‚úÖ {episodes.length} episode(s) available
                          </p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* STEP 3: Select Template */}
              {currentStep === 3 && (
                <div>
                  <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üìã</div>
                    <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                      Choose Your Template
                    </h2>
                    <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                      Select which thumbnail template to use
                    </p>
                  </div>

                  {templates.length === 0 ? (
                    <div style={{
                      maxWidth: '600px',
                      margin: '0 auto',
                      padding: '2rem',
                      background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                      border: '2px solid #f59e0b',
                      borderRadius: '12px',
                      textAlign: 'center'
                    }}>
                      <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>‚ö†Ô∏è</div>
                      <h3 style={{ margin: '0 0 0.5rem 0', fontSize: '1.5rem', fontWeight: '700', color: '#92400e' }}>
                        No Templates Available
                      </h3>
                      <p style={{ margin: 0, fontSize: '1.1rem', color: '#78350f' }}>
                        Please create a template for this show first
                      </p>
                    </div>
                  ) : (
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fill, minmax(400px, 1fr))',
                      gap: '1.5rem',
                      maxWidth: '1200px',
                      margin: '0 auto'
                    }}>
                      {templates.map(template => {
                        const requiredCount = template.required_roles ? template.required_roles.length : 0;
                        const optionalCount = template.optional_roles ? template.optional_roles.length : 0;
                        
                        return (
                          <div
                            key={template.id}
                            onClick={() => {
                              setSelectedTemplateId(template.id);
                              setSelectedTemplate(template);
                            }}
                            style={{
                              padding: '1.5rem',
                              background: selectedTemplateId === template.id 
                                ? 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' 
                                : 'white',
                              border: selectedTemplateId === template.id 
                                ? '3px solid #3b82f6' 
                                : '2px solid #e5e7eb',
                              borderRadius: '12px',
                              cursor: 'pointer',
                              transition: 'all 0.2s',
                              boxShadow: selectedTemplateId === template.id 
                                ? '0 8px 16px rgba(59, 130, 246, 0.2)' 
                                : '0 2px 4px rgba(0,0,0,0.05)'
                            }}
                            onMouseEnter={(e) => {
                              if (selectedTemplateId !== template.id) {
                                e.currentTarget.style.transform = 'translateY(-4px)';
                                e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (selectedTemplateId !== template.id) {
                                e.currentTarget.style.transform = 'translateY(0)';
                                e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                              }
                            }}
                          >
                            <div style={{ display: 'flex', alignItems: 'flex-start', marginBottom: '1rem' }}>
                              <div style={{ fontSize: '2rem', marginRight: '1rem' }}>
                                üìã
                              </div>
                              <div style={{ flex: 1 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.25rem' }}>
                                  <h3 style={{
                                    margin: 0,
                                    fontSize: '1.25rem',
                                    fontWeight: '700',
                                    color: selectedTemplateId === template.id ? '#1e40af' : '#1f2937'
                                  }}>
                                    {template.name}
                                  </h3>
                                  {template.is_active && (
                                    <div style={{
                                      display: 'inline-block',
                                      padding: '0.25rem 0.5rem',
                                      background: '#10b981',
                                      color: 'white',
                                      borderRadius: '6px',
                                      fontSize: '0.7rem',
                                      fontWeight: '600'
                                    }}>
                                      ACTIVE
                                    </div>
                                  )}
                                  {selectedTemplateId === template.id && (
                                    <div style={{
                                      display: 'inline-block',
                                      padding: '0.25rem 0.5rem',
                                      background: '#3b82f6',
                                      color: 'white',
                                      borderRadius: '6px',
                                      fontSize: '0.7rem',
                                      fontWeight: '600'
                                    }}>
                                      SELECTED
                                    </div>
                                  )}
                                </div>
                                <p style={{
                                  margin: '0.5rem 0 0 0',
                                  fontSize: '0.875rem',
                                  color: '#6b7280'
                                }}>
                                  v{template.version}
                                </p>
                              </div>
                            </div>
                            
                            {template.description && (
                              <p style={{
                                margin: '0 0 1rem 0',
                                fontSize: '0.95rem',
                                color: '#374151',
                                lineHeight: '1.5'
                              }}>
                                {template.description}
                              </p>
                            )}
                            
                            <div style={{
                              display: 'grid',
                              gridTemplateColumns: '1fr 1fr',
                              gap: '0.75rem',
                              marginBottom: '1rem'
                            }}>
                              <div style={{
                                padding: '0.75rem',
                                background: '#fef2f2',
                                borderRadius: '8px',
                                textAlign: 'center'
                              }}>
                                <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#dc2626' }}>
                                  {requiredCount}
                                </div>
                                <div style={{ fontSize: '0.75rem', color: '#7f1d1d', fontWeight: '600' }}>
                                  Required Roles
                                </div>
                              </div>
                              <div style={{
                                padding: '0.75rem',
                                background: '#f0fdf4',
                                borderRadius: '8px',
                                textAlign: 'center'
                              }}>
                                <div style={{ fontSize: '1.5rem', fontWeight: '700', color: '#16a34a' }}>
                                  {optionalCount}
                                </div>
                                <div style={{ fontSize: '0.75rem', color: '#14532d', fontWeight: '600' }}>
                                  Optional Roles
                                </div>
                              </div>
                            </div>
                            
                            {template.conditional_roles && Object.keys(template.conditional_roles).length > 0 && (
                              <div style={{
                                padding: '0.75rem',
                                background: '#fef3c7',
                                borderRadius: '8px',
                                fontSize: '0.8rem',
                                color: '#78350f'
                              }}>
                                ‚ö° Has {Object.keys(template.conditional_roles).length} conditional role(s)
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}

              {/* STEP 4: Select Assets - Wardrobe Style */}
              {currentStep === 4 && (
                <div>
                  <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üé®</div>
                    <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                      Build Your Composition
                    </h2>
                    <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                      Assign assets to each role slot
                    </p>
                  </div>

                  {/* Text Field Section */}
                  <div style={{
                    marginBottom: '2.5rem',
                    padding: '1.5rem',
                    background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                    borderRadius: '12px',
                    border: '2px solid #f59e0b',
                    maxWidth: '900px',
                    margin: '0 auto 2.5rem'
                  }}>
                    <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.25rem', fontWeight: '700', color: '#92400e' }}>
                      üìù Show Title
                    </h3>
                    <input
                      type="text"
                      value={textFieldValues['TEXT.SHOW.TITLE'] || ''}
                      onChange={(e) => setTextFieldValues(prev => ({
                        ...prev,
                        'TEXT.SHOW.TITLE': e.target.value
                      }))}
                      placeholder="Enter show title..."
                      required
                      style={{
                        width: '100%',
                        padding: '1rem',
                        border: '2px solid #d97706',
                        borderRadius: '8px',
                        fontSize: '1.1rem',
                        fontWeight: '600',
                        fontFamily: 'inherit',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>

                  {/* Asset Slots Grid */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))',
                    gap: '1.5rem',
                    maxWidth: '1400px',
                    margin: '0 auto'
                  }}>
                    {/* Slot 1: Lala - REQUIRED */}
                    <div style={{
                      padding: '1.5rem',
                      background: 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%)',
                      border: '3px solid #ec4899',
                      borderRadius: '12px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem' }}>
                        <span style={{ fontSize: '2rem' }}>üíú</span>
                        <div>
                          <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#831843' }}>
                            Lala (Host)
                          </h4>
                          <span style={{
                            fontSize: '0.75rem',
                            color: '#be185d',
                            fontWeight: '600',
                            background: 'rgba(255,255,255,0.5)',
                            padding: '0.15rem 0.5rem',
                            borderRadius: '12px'
                          }}>
                            REQUIRED
                          </span>
                        </div>
                      </div>
                      <AssetRolePicker
                        role="CHAR.HOST.LALA"
                        episodeId={episodeId}
                        showId={selectedShowId}
                        selectedAssetId={selectedAssets['CHAR.HOST.LALA'] || ''}
                        onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, 'CHAR.HOST.LALA': assetId }))}
                        required={true}
                        refreshKey={assetRefreshKey}
                      />
                    </div>

                    {/* Slot 2: Background - REQUIRED */}
                    <div style={{
                      padding: '1.5rem',
                      background: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
                      border: '3px solid #3b82f6',
                      borderRadius: '12px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem' }}>
                        <span style={{ fontSize: '2rem' }}>üåÑ</span>
                        <div>
                          <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#1e3a8a' }}>
                            Background
                          </h4>
                          <span style={{
                            fontSize: '0.75rem',
                            color: '#1d4ed8',
                            fontWeight: '600',
                            background: 'rgba(255,255,255,0.5)',
                            padding: '0.15rem 0.5rem',
                            borderRadius: '12px'
                          }}>
                            REQUIRED
                          </span>
                        </div>
                      </div>
                      <AssetRolePicker
                        role="BG.MAIN"
                        episodeId={episodeId}
                        showId={selectedShowId}
                        selectedAssetId={selectedAssets['BG.MAIN'] || ''}
                        onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, 'BG.MAIN': assetId }))}
                        required={true}
                        refreshKey={assetRefreshKey}
                      />
                    </div>

                    {/* Slots 3-4: Guests */}
                    {['CHAR.GUEST.1', 'CHAR.GUEST.2'].map((role, idx) => (
                      <div key={role} style={{
                        padding: '1.5rem',
                        background: visibilityToggles[role] !== false ? 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%)' : '#f9fafb',
                        border: `3px solid ${visibilityToggles[role] !== false ? '#6366f1' : '#e5e7eb'}`,
                        borderRadius: '12px',
                        opacity: visibilityToggles[role] !== false ? 1 : 0.6
                      }}>
                        <label style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.75rem',
                          marginBottom: '1rem',
                          cursor: 'pointer'
                        }}>
                          <input
                            type="checkbox"
                            checked={visibilityToggles[role] !== false}
                            onChange={(e) => setVisibilityToggles(prev => ({ ...prev, [role]: e.target.checked }))}
                            style={{ width: '20px', height: '20px', cursor: 'pointer', accentColor: '#6366f1' }}
                          />
                          <span style={{ fontSize: '2rem' }}>{idx === 0 ? 'üë§' : 'üë•'}</span>
                          <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#3730a3' }}>
                            Guest {idx + 1}
                          </h4>
                        </label>
                        {visibilityToggles[role] !== false && (
                          <AssetRolePicker
                            role={role}
                            episodeId={episodeId}
                            showId={selectedShowId}
                            selectedAssetId={selectedAssets[role] || ''}
                            onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, [role]: assetId }))}
                            required={false}
                            refreshKey={assetRefreshKey}
                          />
                        )}
                      </div>
                    ))}

                    {/* Slots 5-12: 8 Icon Slots */}
                    {[
                      { role: 'UI.ICON.CLOSET', emoji: 'üëó', label: 'Closet', color: '#ec4899' },
                      { role: 'UI.ICON.JEWELRY_BOX', emoji: 'üíé', label: 'Jewelry Box', color: '#8b5cf6' },
                      { role: 'UI.ICON.TODO_LIST', emoji: 'üìã', label: 'To-Do List', color: '#06b6d4' },
                      { role: 'UI.ICON.SPEECH', emoji: 'üí¨', label: 'Speech', color: '#10b981' },
                      { role: 'UI.ICON.LOCATION', emoji: 'üìç', label: 'Location', color: '#f59e0b' },
                      { role: 'UI.ICON.PERFUME', emoji: 'üå∏', label: 'Perfume', color: '#f97316' },
                      { role: 'UI.ICON.POSE', emoji: 'üíÉ', label: 'Pose', color: '#ef4444' },
                      { role: 'UI.ICON.RESERVED', emoji: 'üéØ', label: 'Reserved', color: '#6366f1' }
                    ].map(({ role, emoji, label, color }) => (
                      <div key={role} style={{
                        padding: '1.5rem',
                        background: visibilityToggles[role] ? `linear-gradient(135deg, ${color}15 0%, ${color}25 100%)` : '#f9fafb',
                        border: `3px solid ${visibilityToggles[role] ? color : '#e5e7eb'}`,
                        borderRadius: '12px',
                        opacity: visibilityToggles[role] ? 1 : 0.6
                      }}>
                        <label style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.75rem',
                          marginBottom: '1rem',
                          cursor: 'pointer'
                        }}>
                          <input
                            type="checkbox"
                            checked={!!visibilityToggles[role]}
                            onChange={(e) => {
                              const newVisibility = { ...visibilityToggles, [role]: e.target.checked };
                              const anyIconEnabled = Object.entries(newVisibility).some(
                                ([r, v]) => v && r.includes('.ICON.') && r !== 'UI.ICON.HOLDER.MAIN'
                              );
                              newVisibility['UI.ICON.HOLDER.MAIN'] = anyIconEnabled;
                              setVisibilityToggles(newVisibility);
                            }}
                            style={{ width: '20px', height: '20px', cursor: 'pointer', accentColor: color }}
                          />
                          <span style={{ fontSize: '2rem' }}>{emoji}</span>
                          <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#374151' }}>
                            {label}
                          </h4>
                        </label>
                        {visibilityToggles[role] && (
                          <AssetRolePicker
                            role={role}
                            episodeId={episodeId}
                            showId={selectedShowId}
                            selectedAssetId={selectedAssets[role] || ''}
                            onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, [role]: assetId }))}
                            required={false}
                            refreshKey={assetRefreshKey}
                          />
                        )}
                      </div>
                    ))}

                    {/* Icon Holder - Auto-Managed */}
                    {visibilityToggles['UI.ICON.HOLDER.MAIN'] && (
                      <div style={{
                        padding: '1.5rem',
                        background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
                        border: '3px dashed #3b82f6',
                        borderRadius: '12px'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem' }}>
                          <span style={{ fontSize: '2rem' }}>üéØ</span>
                          <div>
                            <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#1e3a8a' }}>
                              Icon Holder
                            </h4>
                            <span style={{
                              fontSize: '0.75rem',
                              color: '#1d4ed8',
                              fontWeight: '600',
                              background: 'rgba(255,255,255,0.7)',
                              padding: '0.15rem 0.5rem',
                              borderRadius: '12px'
                            }}>
                              AUTO-MANAGED
                            </span>
                          </div>
                        </div>
                        <div style={{
                          padding: '0.75rem',
                          background: 'rgba(59, 130, 246, 0.1)',
                          borderRadius: '6px',
                          fontSize: '0.875rem',
                          color: '#1e40af',
                          marginBottom: '1rem'
                        }}>
                          ‚ÑπÔ∏è Required when any icon is visible
                        </div>
                        <AssetRolePicker
                          role="UI.ICON.HOLDER.MAIN"
                          episodeId={episodeId}
                          showId={selectedShowId}
                          selectedAssetId={selectedAssets['UI.ICON.HOLDER.MAIN'] || ''}
                          onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, 'UI.ICON.HOLDER.MAIN': assetId }))}
                          required={true}
                          refreshKey={assetRefreshKey}
                        />
                      </div>
                    )}

                    {/* Show Title Graphic - OPTIONAL */}
                    <div style={{
                      padding: '1.5rem',
                      background: visibilityToggles['BRAND.SHOW.TITLE_GRAPHIC'] ? 'linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)' : '#f9fafb',
                      border: `3px solid ${visibilityToggles['BRAND.SHOW.TITLE_GRAPHIC'] ? '#a855f7' : '#e5e7eb'}`,
                      borderRadius: '12px',
                      opacity: visibilityToggles['BRAND.SHOW.TITLE_GRAPHIC'] ? 1 : 0.6
                    }}>
                      <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        marginBottom: '1rem',
                        cursor: 'pointer'
                      }}>
                        <input
                          type="checkbox"
                          checked={!!visibilityToggles['BRAND.SHOW.TITLE_GRAPHIC']}
                          onChange={(e) => setVisibilityToggles(prev => ({ ...prev, 'BRAND.SHOW.TITLE_GRAPHIC': e.target.checked }))}
                          style={{ width: '20px', height: '20px', cursor: 'pointer', accentColor: '#a855f7' }}
                        />
                        <span style={{ fontSize: '2rem' }}>üè∑Ô∏è</span>
                        <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#374151' }}>
                          Show Title Graphic
                        </h4>
                      </label>
                      {visibilityToggles['BRAND.SHOW.TITLE_GRAPHIC'] && (
                        <AssetRolePicker
                          role="BRAND.SHOW.TITLE_GRAPHIC"
                          episodeId={episodeId}
                          showId={selectedShowId}
                          selectedAssetId={selectedAssets['BRAND.SHOW.TITLE_GRAPHIC'] || ''}
                          onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, 'BRAND.SHOW.TITLE_GRAPHIC': assetId }))}
                          required={false}
                          refreshKey={assetRefreshKey}
                        />
                      )}
                    </div>

                    {/* UI Chrome Elements - OPTIONAL */}
                    {[
                      { role: 'UI.MOUSE.CURSOR', emoji: 'üñ±Ô∏è', label: 'Mouse Cursor', color: '#6b7280' },
                      { role: 'UI.BUTTON.EXIT', emoji: '‚ùå', label: 'Exit Button', color: '#ef4444' },
                      { role: 'UI.BUTTON.MINIMIZE', emoji: '‚ûñ', label: 'Minimize Button', color: '#f59e0b' }
                    ].map(({ role, emoji, label, color }) => (
                      <div key={role} style={{
                        padding: '1.5rem',
                        background: visibilityToggles[role] ? `linear-gradient(135deg, ${color}11 0%, ${color}22 100%)` : '#f9fafb',
                        border: `3px solid ${visibilityToggles[role] ? color : '#e5e7eb'}`,
                        borderRadius: '12px',
                        opacity: visibilityToggles[role] ? 1 : 0.6
                      }}>
                        <label style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.75rem',
                          marginBottom: '1rem',
                          cursor: 'pointer'
                        }}>
                          <input
                            type="checkbox"
                            checked={!!visibilityToggles[role]}
                            onChange={(e) => setVisibilityToggles(prev => ({ ...prev, [role]: e.target.checked }))}
                            style={{ width: '20px', height: '20px', cursor: 'pointer', accentColor: color }}
                          />
                          <span style={{ fontSize: '2rem' }}>{emoji}</span>
                          <h4 style={{ margin: 0, fontSize: '1.1rem', fontWeight: '700', color: '#374151' }}>
                            {label}
                          </h4>
                        </label>
                        {visibilityToggles[role] && (
                          <AssetRolePicker
                            role={role}
                            episodeId={episodeId}
                            showId={selectedShowId}
                            selectedAssetId={selectedAssets[role] || ''}
                            onChange={(assetId) => setSelectedAssets(prev => ({ ...prev, [role]: assetId }))}
                            required={false}
                            refreshKey={assetRefreshKey}
                          />
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* STEP 5: Select Formats */}
              {currentStep === 5 && (
                <div>
                  <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üì±</div>
                    <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                      Select Platform Formats
                    </h2>
                    <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                      Choose which social media platforms you want thumbnails for ({selectedCount} selected)
                    </p>
                  </div>

                  <div style={{ maxWidth: '900px', margin: '0 auto', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1.25rem' }}>
                    {Object.keys(selectedFormats).map(format => (
                      <div
                        key={format}
                        onClick={() => setSelectedFormats(prev => ({ ...prev, [format]: !prev[format] }))}
                        style={{
                          padding: '1.5rem',
                          background: selectedFormats[format]
                            ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                            : 'white',
                          color: selectedFormats[format] ? 'white' : '#1f2937',
                          border: `3px solid ${selectedFormats[format] ? '#667eea' : '#e5e7eb'}`,
                          borderRadius: '12px',
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                          boxShadow: selectedFormats[format] ? '0 4px 12px rgba(102, 126, 234, 0.3)' : '0 2px 4px rgba(0,0,0,0.05)',
                          transform: selectedFormats[format] ? 'scale(1.02)' : 'scale(1)'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                          <h3 style={{ margin: 0, fontSize: '1.25rem', fontWeight: '700' }}>
                            {getFormatLabel(format)}
                          </h3>
                          <div style={{
                            width: '28px',
                            height: '28px',
                            borderRadius: '50%',
                            background: selectedFormats[format] ? 'white' : '#e5e7eb',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '1rem'
                          }}>
                            {selectedFormats[format] ? '‚úÖ' : ''}
                          </div>
                        </div>
                        <p style={{ margin: '0 0 0.5rem 0', fontSize: '1rem', fontWeight: '600', opacity: selectedFormats[format] ? 1 : 0.7 }}>
                          {getFormatDimensions(format)}
                        </p>
                        {format === 'YOUTUBE' && (
                          <span style={{
                            display: 'inline-block',
                            padding: '0.25rem 0.75rem',
                            background: selectedFormats[format] ? 'rgba(255,255,255,0.2)' : '#fbbf24',
                            color: selectedFormats[format] ? 'white' : '#78350f',
                            borderRadius: '12px',
                            fontSize: '0.75rem',
                            fontWeight: '700',
                            marginTop: '0.5rem'
                          }}>
                            RECOMMENDED
                          </span>
                        )}
                      </div>
                    ))}
                  </div>

                  {selectedCount === 0 && (
                    <div style={{
                      maxWidth: '600px',
                      margin: '2rem auto 0',
                      padding: '1.5rem',
                      background: '#fef3c7',
                      border: '2px solid #f59e0b',
                      borderRadius: '12px',
                      textAlign: 'center'
                    }}>
                      <p style={{ margin: 0, color: '#92400e', fontSize: '1rem' }}>
                        ‚ö†Ô∏è Please select at least one format to continue
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* STEP 6: Review & Generate */}
              {currentStep === 6 && (
                <div>
                  <div style={{ textAlign: 'center', marginBottom: '2.5rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üé¨</div>
                    <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                      Review & Generate
                    </h2>
                    <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                      Confirm your selections and create your thumbnails
                    </p>
                  </div>

                  <div style={{ maxWidth: '700px', margin: '0 auto' }}>
                    {/* Summary Cards */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem', marginBottom: '2rem' }}>
                      {/* Show Summary */}
                      <div style={{ padding: '1.5rem', background: '#f5f3ff', borderRadius: '12px', border: '2px solid #8b5cf6' }}>
                        <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.25rem', fontWeight: '700', color: '#5b21b6', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          üé¨ Show
                        </h3>
                        <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b21a8' }}>
                          {selectedShowName || 'Not selected'}
                        </p>
                      </div>

                      {/* Episode Summary */}
                      <div style={{ padding: '1.5rem', background: '#eff6ff', borderRadius: '12px', border: '2px solid #3b82f6' }}>
                        <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.25rem', fontWeight: '700', color: '#1e3a8a', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          üì∫ Episode
                        </h3>
                        <p style={{ margin: 0, fontSize: '1.1rem', color: '#1e40af' }}>
                          {episodeName || `ID: ${episodeId.substring(0, 12)}...`}
                        </p>
                      </div>

                      {/* Template Summary */}
                      <div style={{ padding: '1.5rem', background: '#fef3c7', borderRadius: '12px', border: '2px solid #f59e0b' }}>
                        <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.25rem', fontWeight: '700', color: '#92400e', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          üìã Template
                        </h3>
                        <p style={{ margin: 0, fontSize: '1.1rem', color: '#78350f' }}>
                          {selectedTemplate ? selectedTemplate.name : 'Not selected'}
                        </p>
                      </div>

                      {/* Assets Summary */}
                      <div style={{ padding: '1.5rem', background: '#f0fdf4', borderRadius: '12px', border: '2px solid #10b981' }}>
                        <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.25rem', fontWeight: '700', color: '#065f46', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          üñºÔ∏è Assets Selected
                        </h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          {selectedTemplate && selectedTemplate.required_roles && 
                            selectedTemplate.required_roles.map(role => (
                              <div key={role} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <span>{selectedAssets[role] ? '‚úÖ' : '‚ùå'}</span>
                                <span style={{ color: selectedAssets[role] ? '#047857' : '#dc2626', fontWeight: '600' }}>
                                  {role}
                                </span>
                                <span style={{ fontSize: '0.75rem', color: '#6b7280' }}>(Required)</span>
                              </div>
                            ))
                          }
                          {selectedTemplate && selectedTemplate.optional_roles && 
                            selectedTemplate.optional_roles
                              .filter(role => selectedAssets[role]) // Only show selected optional assets
                              .map(role => (
                                <div key={role} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <span>‚úÖ</span>
                                  <span style={{ color: '#047857' }}>
                                    {role}
                                  </span>
                                  <span style={{ fontSize: '0.75rem', color: '#6b7280' }}>(Optional)</span>
                                </div>
                              ))
                          }
                          {(!selectedTemplate || (!selectedTemplate.required_roles?.length && !Object.keys(selectedAssets).length)) && (
                            <p style={{ margin: 0, color: '#6b7280', fontStyle: 'italic' }}>
                              No assets selected
                            </p>
                          )}
                        </div>
                      </div>

                      {/* Formats Summary */}
                      <div style={{ padding: '1.5rem', background: '#faf5ff', borderRadius: '12px', border: '2px solid #a855f7' }}>
                        <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.25rem', fontWeight: '700', color: '#6b21a8', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          üì± Formats ({selectedCount})
                        </h3>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                          {Object.entries(selectedFormats)
                            .filter(([_, selected]) => selected)
                            .map(([format]) => (
                              <span
                                key={format}
                                style={{
                                  padding: '0.5rem 1rem',
                                  background: '#a855f7',
                                  color: 'white',
                                  borderRadius: '8px',
                                  fontSize: '0.875rem',
                                  fontWeight: '600'
                                }}
                              >
                                {getFormatLabel(format)}
                              </span>
                            ))}
                        </div>
                      </div>
                    </div>

                    {/* Generate Button */}
                    <button
                      onClick={handleSubmit}
                      disabled={loading}
                      style={{
                        width: '100%',
                        padding: '1.5rem',
                        background: loading ? '#9ca3af' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '12px',
                        fontSize: '1.25rem',
                        fontWeight: '700',
                        cursor: loading ? 'not-allowed' : 'pointer',
                        boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '0.75rem'
                      }}
                    >
                      {loading ? (
                        <>
                          <span>‚è≥</span>
                          <span>Generating...</span>
                        </>
                      ) : (
                        <>
                          <span>üöÄ</span>
                          <span>Generate {selectedCount} Thumbnail{selectedCount !== 1 ? 's' : ''}</span>
                        </>
                      )}
                    </button>
                  </div>
                </div>
              )}
            </div>

            {/* Navigation Buttons */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              gap: '1rem',
              marginTop: '2rem',
              maxWidth: '800px',
              marginLeft: 'auto',
              marginRight: 'auto'
            }}>
              <button
                onClick={prevStep}
                disabled={currentStep === 1}
                style={{
                  flex: '1',
                  padding: '1rem 2rem',
                  background: currentStep === 1 ? '#e5e7eb' : 'white',
                  color: currentStep === 1 ? '#9ca3af' : '#374151',
                  border: '2px solid #d1d5db',
                  borderRadius: '10px',
                  fontSize: '1rem',
                  fontWeight: '600',
                  cursor: currentStep === 1 ? 'not-allowed' : 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                ‚Üê Previous
              </button>
              
              {currentStep < totalSteps && (
                <button
                  onClick={nextStep}
                  disabled={!canProceedToStep(currentStep + 1)}
                  style={{
                    flex: '1',
                    padding: '1rem 2rem',
                    background: canProceedToStep(currentStep + 1)
                      ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                      : '#e5e7eb',
                    color: canProceedToStep(currentStep + 1) ? 'white' : '#9ca3af',
                    border: 'none',
                    borderRadius: '10px',
                    fontSize: '1rem',
                    fontWeight: '600',
                    cursor: canProceedToStep(currentStep + 1) ? 'pointer' : 'not-allowed',
                    boxShadow: canProceedToStep(currentStep + 1) ? '0 4px 12px rgba(102, 126, 234, 0.3)' : 'none',
                    transition: 'all 0.2s'
                  }}
                >
                  Next Step ‚Üí
                </button>
              )}
            </div>
          </>
        ) : (
          /* Compositions Gallery */
          <div style={{ padding: '2rem 0' }}>
            <div style={{ marginBottom: '2rem', textAlign: 'center' }}>
              <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700', color: '#1f2937' }}>
                üì∏ Thumbnail Gallery
              </h2>
              <p style={{ margin: 0, fontSize: '1.1rem', color: '#6b7280' }}>
                View and manage your created compositions
              </p>
            </div>
            
            {compositions.length === 0 ? (
              <div style={{ 
                textAlign: 'center', 
                padding: '4rem 2rem',
                background: 'white',
                borderRadius: '16px',
                boxShadow: '0 4px 16px rgba(0,0,0,0.08)'
              }}>
                <div style={{ fontSize: '5rem', marginBottom: '1rem' }}>üé®</div>
                <h3 style={{ margin: '0 0 1rem 0', fontSize: '1.5rem', fontWeight: '700', color: '#1f2937' }}>
                  No Compositions Yet
                </h3>
                <p style={{ margin: 0, color: '#6b7280', fontSize: '1.1rem' }}>
                  Create your first composition using the wizard!
                </p>
              </div>
            ) : (
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1.5rem' }}>
                {compositions.map(comp => {
                  const episodeName = comp.episodeName || comp.episode?.episodeTitle || comp.episode?.title || 'Unknown Episode';
                  const status = comp.approval_status || comp.status || 'DRAFT';
                  const createdDate = comp.created_at || comp.createdAt;
                  const formatsArray = Array.isArray(comp.selected_formats) 
                    ? comp.selected_formats 
                    : (Array.isArray(comp.formats) 
                      ? comp.formats 
                      : []);
                  const thumbnailCount = comp.thumbnails_generated || formatsArray.length || 0;
                  
                  return (
                    <div key={comp.id} style={{
                      background: 'white',
                      border: '2px solid var(--gray-200)',
                      borderRadius: 'var(--radius)',
                      overflow: 'hidden',
                      transition: 'all 0.3s',
                    }}>
                      <div style={{
                        width: '100%',
                        aspectRatio: '16 / 9',
                        background: comp.preview_url ? `url(${comp.preview_url})` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        backgroundSize: 'cover',
                        backgroundPosition: 'center',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: 'white',
                        fontSize: '1rem',
                        fontWeight: 'bold',
                        padding: '1.5rem',
                        textAlign: 'center',
                      }}>
                        {!comp.preview_url && (
                          <>
                            <div>üì∫ {episodeName}</div>
                            <div style={{ fontSize: '0.85rem', marginTop: '0.5rem', opacity: 0.9 }}>
                              {thumbnailCount} {thumbnailCount === 1 ? 'format' : 'formats'}
                            </div>
                          </>
                        )}
                      </div>
                      
                      <div style={{ padding: '1.5rem' }}>
                        <p style={{ margin: '0 0 0.5rem 0', fontSize: '1.1rem', fontWeight: '700', color: 'var(--gray-900)' }}>
                          {episodeName}
                        </p>
                        <p style={{ margin: '0 0 0.5rem 0', fontSize: '0.9rem', color: 'var(--gray-700)' }}>
                          {thumbnailCount} {thumbnailCount === 1 ? 'format' : 'formats'}
                        </p>
                        <p style={{ margin: '0 0 0.5rem 0', fontSize: '0.9rem' }}>
                          <strong>Status:</strong>{' '}
                          <span style={{ 
                            padding: '0.25rem 0.625rem', 
                            borderRadius: '12px',
                            fontSize: '0.8rem',
                            fontWeight: '700',
                            background: status === 'APPROVED' ? '#10b981' : '#f59e0b',
                            color: 'white'
                          }}>
                            {status}
                          </span>
                        </p>
                        <p style={{ margin: '0 0 1rem 0', fontSize: '0.85rem', color: 'var(--gray-700)' }}>
                          <strong>Created:</strong> {createdDate ? new Date(createdDate).toLocaleDateString() : 'Just now'}
                        </p>
                        
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                          <button 
                            onClick={() => handleGenerateThumbnails(comp)}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#9c27b0',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.85rem',
                              fontWeight: '700',
                              transition: 'all 0.2s'
                            }}
                          >
                            üé¨ Generate
                          </button>
                          <button 
                            onClick={() => handleDeleteComposition(comp)}
                            style={{
                              padding: '0.5rem 1rem',
                              background: '#ef4444',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.85rem',
                              fontWeight: '700',
                              transition: 'all 0.2s'
                            }}
                          >
                            üóëÔ∏è Delete
                          </button>
                        </div>
                      </div>

                      {thumbnails[comp.id] && thumbnails[comp.id].length > 0 && (
                        <div style={{ padding: '0 1.5rem 1.5rem' }}>
                          <h4 style={{ margin: '0 0 0.75rem 0', fontSize: '0.9rem', fontWeight: '700' }}>
                            üì∏ Generated Thumbnails ({thumbnails[comp.id].length})
                          </h4>
                          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                            {thumbnails[comp.id].map((thumb, idx) => (
                              <div key={idx} style={{
                                flex: '1 1 auto',
                                minWidth: '120px',
                                border: '1px solid #e5e7eb',
                                borderRadius: '6px',
                                overflow: 'hidden',
                                background: '#f9fafb'
                              }}>
                                <a 
                                  href={thumb.s3_url} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                >
                                  <img 
                                    src={thumb.s3_url} 
                                    alt={thumb.formatName} 
                                    style={{
                                      width: '100%',
                                      height: '80px',
                                      objectFit: 'cover',
                                      cursor: 'pointer'
                                    }}
                                  />
                                </a>
                                <p style={{ 
                                  fontSize: '0.75rem', 
                                  padding: '0.25rem 0.5rem',
                                  margin: 0,
                                  whiteSpace: 'nowrap',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis'
                                }}>
                                  {thumb.formatName || thumb.format}
                                </p>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

export default ThumbnailComposer;
