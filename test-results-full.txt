
> episode-metadata-api@1.0.0 test
> cross-env NODE_ENV=test jest --coverage --runInBand

FAIL tests/integration/auth.integration.test.js
  ΓùÅ Console

    console.log
      ≡ƒÜÇ Starting Episode Metadata API...

      at Object.log (src/app.js:69:9)

    console.log
      ≡ƒôª Node version: v20.19.4

      at Object.log (src/app.js:70:9)

    console.log
      ≡ƒöº Environment: test

      at Object.log (src/app.js:71:9)

    console.log
      Γ£ô Auth routes loaded

      at Object.log (src/app.js:157:11)

    console.log
      Γ£ô Episodes routes loaded

      at Object.log (src/app.js:173:11)

    console.log
      Γ£ô Thumbnails routes loaded

      at Object.log (src/app.js:181:11)

    console.log
      Γ£ô Metadata routes loaded

      at Object.log (src/app.js:189:11)

    console.log
      Γ£ô Processing routes loaded

      at Object.log (src/app.js:197:11)

    console.log
      Γ£ô Files routes loaded

      at Object.log (src/app.js:206:11)

    console.log
      Γ£ô Search routes loaded

      at Object.log (src/app.js:214:11)

    console.log
      Γ£ô Jobs routes loaded

      at Object.log (src/app.js:222:11)

    console.log
      Γ£ô Assets routes loaded

      at Object.log (src/app.js:231:11)

    console.log
      Γ£ô Compositions routes loaded

      at Object.log (src/app.js:239:11)

    console.log
      Γ£ô Templates routes loaded

      at Object.log (src/app.js:247:11)

    console.log
      Γ£ô Seed routes loaded (development only)

      at Object.log (src/app.js:257:11)

    console.log
      Γ£à AWS SDK v3 configured with credentials from profile: default

      at log (src/routes/compositions.js:39:11)

    console.warn
      Optional auth token invalid: Token verification failed: Invalid token format

      156 |     } catch (error) {
      157 |       // Log but don't fail - user is optional
    > 158 |       console.warn('Optional auth token invalid:', error.message);
          |               ^
      159 |       req.user = null;
      160 |     }
      161 |

      at warn (src/middleware/auth.js:158:15)

    console.warn
      Optional auth token invalid: Token verification failed: Invalid token format

      156 |     } catch (error) {
      157 |       // Log but don't fail - user is optional
    > 158 |       console.warn('Optional auth token invalid:', error.message);
          |               ^
      159 |       req.user = null;
      160 |     }
      161 |

      at warn (src/middleware/auth.js:158:15)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/v1/auth/refresh ΓÇ║ should reject refresh with expired token

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      151 |         });
      152 |
    > 153 |       expect(res.status).toBe(401);
          |                          ^
      154 |       expect(res.body).toHaveProperty('error');
      155 |     });
      156 |   });

      at Object.toBe (tests/integration/auth.integration.test.js:153:26)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/v1/auth/logout ΓÇ║ should add token to blacklist after logout

    expect(received).toMatch(expected)

    Expected pattern: /revoked/i
    Received string:  "Token is invalid"

      196 |
      197 |       expect(validateRes.status).toBe(401);
    > 198 |       expect(validateRes.body.message).toMatch(/revoked/i);
          |                                        ^
      199 |     });
      200 |   });
      201 |

      at Object.toMatch (tests/integration/auth.integration.test.js:198:40)

  ΓùÅ Authentication API Integration Tests ΓÇ║ End-to-End Authentication Flow ΓÇ║ should complete full auth cycle: login -> use token -> refresh -> logout

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      316 |         .set('Authorization', `Bearer ${token1}`);
      317 |
    > 318 |       expect(meRes.status).toBe(200);
          |                            ^
      319 |       expect(meRes.body.data.user.email).toBe('e2e@test.dev');
      320 |
      321 |       // 3. Refresh token

      at Object.toBe (tests/integration/auth.integration.test.js:318:28)

FAIL tests/integration/assets.integration.test.js
  ΓùÅ Console

    console.log
      ≡ƒÜÇ Starting Episode Metadata API...

      at Object.log (src/app.js:69:9)

    console.log
      ≡ƒôª Node version: v20.19.4

      at Object.log (src/app.js:70:9)

    console.log
      ≡ƒöº Environment: test

      at Object.log (src/app.js:71:9)

    console.log
      Γ£ô Auth routes loaded

      at Object.log (src/app.js:157:11)

    console.log
      Γ£ô Episodes routes loaded

      at Object.log (src/app.js:173:11)

    console.log
      Γ£ô Thumbnails routes loaded

      at Object.log (src/app.js:181:11)

    console.log
      Γ£ô Metadata routes loaded

      at Object.log (src/app.js:189:11)

    console.log
      Γ£ô Processing routes loaded

      at Object.log (src/app.js:197:11)

    console.log
      Γ£ô Files routes loaded

      at Object.log (src/app.js:206:11)

    console.log
      Γ£ô Search routes loaded

      at Object.log (src/app.js:214:11)

    console.log
      Γ£ô Jobs routes loaded

      at Object.log (src/app.js:222:11)

    console.log
      Γ£ô Assets routes loaded

      at Object.log (src/app.js:231:11)

    console.log
      Γ£ô Compositions routes loaded

      at Object.log (src/app.js:239:11)

    console.log
      Γ£ô Templates routes loaded

      at Object.log (src/app.js:247:11)

    console.log
      Γ£ô Seed routes loaded (development only)

      at Object.log (src/app.js:257:11)

    console.log
      Γ£à AWS SDK v3 configured with credentials from profile: default

      at log (src/routes/compositions.js:39:11)

    console.error
      Failed to get asset: Error: Asset not found
          at AssetService.getAsset (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\services\AssetService.js:138:15)
          at processTicksAndRejections (node:internal/process/task_queues:95:5)
          at C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\routes\assets.js:109:19

      144 |       };
      145 |     } catch (error) {
    > 146 |       console.error('Failed to get asset:', error);
          |               ^
      147 |       throw error;
      148 |     }
      149 |   }

      at AssetService.error [as getAsset] (src/services/AssetService.js:146:15)
      at src/routes/assets.js:109:19

    console.error
      Failed to get asset: Error: Asset not found
          at AssetService.getAsset (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\services\AssetService.js:138:15)
          at processTicksAndRejections (node:internal/process/task_queues:95:5)
          at C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\routes\assets.js:109:19

      120 |     });
      121 |   } catch (error) {
    > 122 |     console.error('Failed to get asset:', error);
          |             ^
      123 |     res.status(500).json({
      124 |       error: 'Failed to get asset',
      125 |       message: error.message,

      at error (src/routes/assets.js:122:13)

    console.error
      Failed to get asset: Error: Asset not found
          at AssetService.getAsset (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\services\AssetService.js:138:15)
          at processTicksAndRejections (node:internal/process/task_queues:95:5)
          at C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\routes\assets.js:109:19

      144 |       };
      145 |     } catch (error) {
    > 146 |       console.error('Failed to get asset:', error);
          |               ^
      147 |       throw error;
      148 |     }
      149 |   }

      at AssetService.error [as getAsset] (src/services/AssetService.js:146:15)
      at src/routes/assets.js:109:19

    console.error
      Failed to get asset: Error: Asset not found
          at AssetService.getAsset (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\services\AssetService.js:138:15)
          at processTicksAndRejections (node:internal/process/task_queues:95:5)
          at C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\src\routes\assets.js:109:19

      120 |     });
      121 |   } catch (error) {
    > 122 |     console.error('Failed to get asset:', error);
          |             ^
      123 |     res.status(500).json({
      124 |       error: 'Failed to get asset',
      125 |       message: error.message,

      at error (src/routes/assets.js:122:13)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should reject asset upload without file

    expect(received).toMatch(expected)

    Matcher error: received value must be a string

    Received has value: undefined

      36 |       expect(res.status).toBe(400);
      37 |       expect(res.body).toHaveProperty('error');
    > 38 |       expect(res.body.message).toMatch(/No file provided/i);
         |                                ^
      39 |     });
      40 |
      41 |     it('should reject asset upload without assetType', async () => {

      at Object.toMatch (tests/integration/assets.integration.test.js:38:32)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should reject asset upload with invalid assetType

    expect(received).toMatch(expected)

    Expected pattern: /must be one of:/i
    Received string:  "assetType is required"

      59 |       expect(res.status).toBe(400);
      60 |       expect(res.body).toHaveProperty('error');
    > 61 |       expect(res.body.details[0]).toMatch(/must be one of:/i);
         |                                   ^
      62 |     });
      63 |
      64 |     it('should validate asset types', async () => {

      at Object.toMatch (tests/integration/assets.integration.test.js:61:35)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should validate asset types

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not 400

      79 |
      80 |         // Should not fail on validation (may fail on file processing, but not validation)
    > 81 |         expect(res.status).not.toBe(400);
         |                                ^
      82 |         // OR if it's 400, it shouldn't be validation error
      83 |         if (res.status === 400) {
      84 |           expect(res.body.error).not.toBe('Validation failed');

      at Object.toBe (tests/integration/assets.integration.test.js:81:32)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should reject invalid metadata JSON

    expect(received).toContain(expected) // indexOf

    Expected value: "Metadata must be valid JSON"
    Received array: ["assetType is required"]

       97 |       expect(res.status).toBe(400);
       98 |       expect(res.body).toHaveProperty('error');
    >  99 |       expect(res.body.details).toContain('Metadata must be valid JSON');
          |                                ^
      100 |     });
      101 |
      102 |     it('should accept valid metadata JSON', async () => {

      at Object.toContain (tests/integration/assets.integration.test.js:99:32)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should accept empty metadata

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not "Validation failed"

      125 |       // Should not be a validation error
      126 |       if (res.status === 400) {
    > 127 |         expect(res.body.error).not.toBe('Validation failed');
          |                                    ^
      128 |       }
      129 |     });
      130 |   });

      at Object.toBe (tests/integration/assets.integration.test.js:127:36)

  ΓùÅ Assets API Integration Tests ΓÇ║ Error Handling ΓÇ║ should return proper error for non-existent asset

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

      205 |         .get(`/api/v1/assets/${nonExistentId}`);
      206 |
    > 207 |       expect(res.status).toBe(404);
          |                          ^
      208 |       expect(res.body).toHaveProperty('error');
      209 |     });
      210 |

      at Object.toBe (tests/integration/assets.integration.test.js:207:26)

  ΓùÅ Assets API Integration Tests ΓÇ║ Asset Upload Validation Flow ΓÇ║ should validate all required fields before upload

    expect(received).toContain(expected) // indexOf

    Expected substring: "must be one of"
    Received string:    "assettype is required"

      255 |         // Should get validation error or other 400 error
      256 |         if (res.status === 400 && res.body.error === 'Validation failed') {
    > 257 |           expect(res.body.details[0].toLowerCase()).toContain(testCase.expectedError.toLowerCase());
          |                                                     ^
      258 |         }
      259 |       }
      260 |     });

      at Object.toContain (tests/integration/assets.integration.test.js:257:53)

FAIL tests/integration/episodes.integration.test.js
  ΓùÅ Console

    console.log
      ≡ƒÜÇ Starting Episode Metadata API...

      at Object.log (src/app.js:69:9)

    console.log
      ≡ƒôª Node version: v20.19.4

      at Object.log (src/app.js:70:9)

    console.log
      ≡ƒöº Environment: test

      at Object.log (src/app.js:71:9)

    console.log
      Γ£ô Auth routes loaded

      at Object.log (src/app.js:157:11)

    console.log
      Γ£ô Episodes routes loaded

      at Object.log (src/app.js:173:11)

    console.log
      Γ£ô Thumbnails routes loaded

      at Object.log (src/app.js:181:11)

    console.log
      Γ£ô Metadata routes loaded

      at Object.log (src/app.js:189:11)

    console.log
      Γ£ô Processing routes loaded

      at Object.log (src/app.js:197:11)

    console.log
      Γ£ô Files routes loaded

      at Object.log (src/app.js:206:11)

    console.log
      Γ£ô Search routes loaded

      at Object.log (src/app.js:214:11)

    console.log
      Γ£ô Jobs routes loaded

      at Object.log (src/app.js:222:11)

    console.log
      Γ£ô Assets routes loaded

      at Object.log (src/app.js:231:11)

    console.log
      Γ£ô Compositions routes loaded

      at Object.log (src/app.js:239:11)

    console.log
      Γ£ô Templates routes loaded

      at Object.log (src/app.js:247:11)

    console.log
      Γ£ô Seed routes loaded (development only)

      at Object.log (src/app.js:257:11)

    console.log
      Γ£à AWS SDK v3 configured with credentials from profile: default

      at log (src/routes/compositions.js:39:11)

  ΓùÅ Episodes API Integration Tests ΓÇ║ GET /api/v1/episodes ΓÇ║ should filter by status

    expect(received).toBe(expected) // Object.is equality

    Expected: "approved"
    Received: "published"

      72 |       if (res.body.data.length > 0) {
      73 |         res.body.data.forEach(episode => {
    > 74 |           expect(episode.status?.toLowerCase()).toBe('approved');
         |                                                 ^
      75 |         });
      76 |       }
      77 |     });

      at toBe (tests/integration/episodes.integration.test.js:74:49)
          at Array.forEach (<anonymous>)
      at Object.forEach (tests/integration/episodes.integration.test.js:73:23)

FAIL tests/unit/controllers/episode.test.js
  ΓùÅ Console

    console.error
      Γ¥î Error in listEpisodes: Error: DB connection failed
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\controllers\episode.test.js:475:23)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      49 |       });
      50 |     } catch (error) {
    > 51 |       console.error('Γ¥î Error in listEpisodes:', error);
         |               ^
      52 |       res.status(500).json({
      53 |         error: 'Failed to list episodes',
      54 |         message: error.message

      at Object.error [as listEpisodes] (src/controllers/episodeController.js:51:15)
      at Object.<anonymous> (tests/unit/controllers/episode.test.js:478:7)

  ΓùÅ Episode Controller - Real Tests ΓÇ║ getEpisode() ΓÇ║ should return episode with includes

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "1", Any<Object>

    Number of calls: 0

      142 |       await episodeController.getEpisode(mockReq, mockRes);
      143 |
    > 144 |       expect(models.Episode.findByPk).toHaveBeenCalledWith('1', expect.any(Object));
          |                                       ^
      145 |       expect(mockRes.json).toHaveBeenCalledWith({ data: mockEpisode });
      146 |     });
      147 |

      at Object.toHaveBeenCalledWith (tests/unit/controllers/episode.test.js:144:39)

PASS tests/unit/app.test.js
  ΓùÅ Console

    console.log
      ≡ƒÜÇ Starting Episode Metadata API...

      at Object.log (src/app.js:69:9)

    console.log
      ≡ƒôª Node version: v20.19.4

      at Object.log (src/app.js:70:9)

    console.log
      ≡ƒöº Environment: test

      at Object.log (src/app.js:71:9)

    console.log
      Γ£ô Auth routes loaded

      at Object.log (src/app.js:157:11)

    console.log
      Γ£ô Episodes routes loaded

      at Object.log (src/app.js:173:11)

    console.log
      Γ£ô Thumbnails routes loaded

      at Object.log (src/app.js:181:11)

    console.log
      Γ£ô Metadata routes loaded

      at Object.log (src/app.js:189:11)

    console.log
      Γ£ô Processing routes loaded

      at Object.log (src/app.js:197:11)

    console.log
      Γ£ô Files routes loaded

      at Object.log (src/app.js:206:11)

    console.log
      Γ£ô Search routes loaded

      at Object.log (src/app.js:214:11)

    console.log
      Γ£ô Jobs routes loaded

      at Object.log (src/app.js:222:11)

    console.log
      Γ£ô Assets routes loaded

      at Object.log (src/app.js:231:11)

    console.log
      Γ£ô Compositions routes loaded

      at Object.log (src/app.js:239:11)

    console.log
      Γ£ô Templates routes loaded

      at Object.log (src/app.js:247:11)

    console.log
      Γ£ô Seed routes loaded (development only)

      at Object.log (src/app.js:257:11)


  ΓùÅ  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Γ£à AWS SDK v3 configured with credentials from profile: default".

      37 | (async () => {
      38 |   s3Client = await createS3Client();
    > 39 |   console.log('Γ£à AWS SDK v3 configured with credentials from', process.env.AWS_PROFILE ? `profile: ${process.env.AWS_PROFILE}` : 'environment');
         |           ^
      40 | })();
      41 |
      42 | const router = express.Router();

      at console.log (node_modules/@jest/console/build/BufferedConsole.js:156:10)
      at log (src/routes/compositions.js:39:11)

PASS tests/unit/middleware/auditLog.test.js
  ΓùÅ Console

    console.error
      Error logging action: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:82:28)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      182 |       });
      183 |     } catch (error) {
    > 184 |       console.error('Error logging action:', error);
          |               ^
      185 |       return null;
      186 |     }
      187 |   },

      at Object.error [as logAction] (src/middleware/auditLog.js:184:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:85:22)

    console.error
      Error fetching user history: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:110:71)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      198 |       return await ActivityLog.getUserHistory(userId, options);
      199 |     } catch (error) {
    > 200 |       console.error('Error fetching user history:', error);
          |               ^
      201 |       return [];
      202 |     }
      203 |   },

      at Object.error [as getUserHistory] (src/middleware/auditLog.js:200:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:112:20)

    console.error
      Error fetching resource history: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:132:75)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      214 |       return await ActivityLog.getResourceHistory(resourceType, resourceId);
      215 |     } catch (error) {
    > 216 |       console.error('Error fetching resource history:', error);
          |               ^
      217 |       return [];
      218 |     }
      219 |   },

      at Object.error [as getResourceHistory] (src/middleware/auditLog.js:216:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:134:20)

    console.error
      Error fetching audit trail: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:158:70)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      230 |       return await ActivityLog.getAuditTrail(options);
      231 |     } catch (error) {
    > 232 |       console.error('Error fetching audit trail:', error);
          |               ^
      233 |       return [];
      234 |     }
      235 |   },

      at Object.error [as getAuditTrail] (src/middleware/auditLog.js:232:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:160:21)

    console.error
      Error fetching stats: Error: error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:182:65)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      246 |       return await ActivityLog.getStats(timeRange);
      247 |     } catch (error) {
    > 248 |       console.error('Error fetching stats:', error);
          |               ^
      249 |       return {};
      250 |     }
      251 |   },

      at Object.error [as getStats] (src/middleware/auditLog.js:248:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:184:21)

    console.error
      Error logging action: Error: Connection error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:492:68)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      182 |       });
      183 |     } catch (error) {
    > 184 |       console.error('Error logging action:', error);
          |               ^
      185 |       return null;
      186 |     }
      187 |   },

      at Object.error [as logAction] (src/middleware/auditLog.js:184:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:494:22)

    console.error
      Error fetching stats: Error: Stats error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\middleware\auditLog.test.js:668:65)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      246 |       return await ActivityLog.getStats(timeRange);
      247 |     } catch (error) {
    > 248 |       console.error('Error fetching stats:', error);
          |               ^
      249 |       return {};
      250 |     }
      251 |   },

      at Object.error [as getStats] (src/middleware/auditLog.js:248:15)
      at Object.<anonymous> (tests/unit/middleware/auditLog.test.js:670:21)

PASS tests/unit/controllers/processing.test.js
PASS tests/unit/controllers/thumbnail.test.js
  ΓùÅ Console

    console.error
      Γ¥î Error in listThumbnails: Error: DB error
          at Object.<anonymous> (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\tests\unit\controllers\thumbnail.test.js:321:70)
          at Promise.then.completed (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:298:28)
          at new Promise (<anonymous>)
          at callAsyncCircusFn (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\utils.js:231:10)
          at _callCircusTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:316:40)
          at _runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:252:3)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:126:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at _runTestsForDescribeBlock (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:121:9)
          at run (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\run.js:71:3)
          at runAndTransformResultsToJestFormat (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapterInit.js:122:21)
          at jestAdapter (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-circus\build\legacy-code-todo-rewrite\jestAdapter.js:79:19)
          at runTestInternal (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:367:16)
          at runTest (C:\Users\12483\prime studios\BRD\Episode-Canonical-Control-Record\node_modules\jest-runner\build\runTest.js:444:34)

      63 |       });
      64 |     } catch (error) {
    > 65 |       console.error('Γ¥î Error in listThumbnails:', error);
         |               ^
      66 |       res.status(500).json({
      67 |         error: 'Failed to list thumbnails',
      68 |         message: error.message

      at Object.error [as listThumbnails] (src/controllers/thumbnailController.js:65:15)
      at Object.<anonymous> (tests/unit/controllers/thumbnail.test.js:323:7)

PASS tests/unit/controllers/metadata.test.js
  ΓùÅ Console

    console.error
      Metadata query error (schema mismatch): DB error

      60 |     } catch (error) {
      61 |       // If metadata table schema is mismatched, return empty list
    > 62 |       console.error('Metadata query error (schema mismatch):', error.message);
         |               ^
      63 |       res.json({
      64 |         data: [],
      65 |         pagination: {

      at Object.error [as listMetadata] (src/controllers/metadataController.js:62:15)
      at Object.<anonymous> (tests/unit/controllers/metadata.test.js:296:7)

PASS tests/unit/middleware/auditLog-additional.test.js
PASS tests/unit/models/activityLog.test.js
PASS tests/unit/middleware/rbac.test.js
PASS tests/unit/middleware/errorHandler.test.js
PASS tests/unit/services/JobQueueService.test.js
PASS tests/unit/middleware/jwtAuth.test.js
PASS tests/unit/controllers/jobController.test.js
PASS tests/api/endpoints.test.js
PASS tests/unit/services/OpenSearchService.test.js
PASS tests/unit/services/FileValidationService.test.js
PASS tests/unit/models/metadata-methods.test.js
PASS tests/unit/services/S3Service.test.js
PASS tests/unit/middleware/auth.test.js
PASS tests/unit/controllers/searchController.test.js
PASS tests/unit/controllers/fileController.test.js
PASS tests/unit/models/episode.test.js
PASS tests/unit/middleware/auth-gaps.test.js
-----------------------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                                                 | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                          
-----------------------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                                            |   52.56 |    39.89 |   47.03 |   53.17 |                                                                                                                                                                            
 src                                                 |   47.15 |       28 |    7.69 |   50.27 |                                                                                                                                                                            
  app.js                                             |      55 |    28.12 |      10 |   59.45 | 18-47,56,60-62,79,91,136-142,159-160,175-176,183-184,191-192,199-200,208-209,216-217,224-225,233-234,241-242,249-250,259-260,283,320-322                                   
  db.js                                              |      75 |       50 |       0 |      75 | 13                                                                                                                                                                         
  server.js                                          |       0 |        0 |       0 |       0 | 7-76                                                                                                                                                                       
 src/config                                          |       0 |        0 |       0 |       0 |                                                                                                                                                                            
  aws.js                                             |       0 |        0 |     100 |       0 | 7-17                                                                                                                                                                       
  database.js                                        |       0 |        0 |       0 |       0 | 7-36                                                                                                                                                                       
  environment.js                                     |       0 |        0 |     100 |       0 | 5-47                                                                                                                                                                       
  sequelize.js                                       |       0 |        0 |     100 |       0 | 6                                                                                                                                                                          
 src/controllers                                     |   85.05 |    63.47 |    94.2 |   85.19 |                                                                                                                                                                            
  episodeController.js                               |   91.89 |       76 |     100 |   91.89 | 82-83,142-143,186,227                                                                                                                                                      
  fileController.js                                  |   84.72 |    77.77 |   83.33 |   86.95 | 236-266                                                                                                                                                                    
  jobController.js                                   |     100 |      100 |     100 |     100 |                                                                                                                                                                            
  metadataController.js                              |   72.34 |    46.66 |      90 |   72.04 | 91,118,153,162,214,237-245,294,327,335,365-406,420                                                                                                                         
  processingController.js                            |   88.65 |    67.85 |     100 |   89.36 | 86,111,123,134,178,185,202,235,284,327                                                                                                                                     
  searchController.js                                |   89.58 |      100 |   88.88 |   88.88 | 98-104                                                                                                                                                                     
  thumbnailController.js                             |   77.08 |    36.84 |    90.9 |   76.59 | 104,112-192,207,224,258,292,325,377,412                                                                                                                                    
 src/middleware                                      |   73.71 |    68.67 |   74.02 |   74.25 |                                                                                                                                                                            
  auditLog.js                                        |   69.76 |    58.82 |    64.7 |   70.23 | 67-78,110-116,126-155,170,195,211,227,243                                                                                                                                  
  auth.js                                            |   71.42 |    59.52 |      50 |   72.46 | 50,69,114,137-138,164-166,175-192,206-222                                                                                                                                  
  errorHandler.js                                    |     100 |    95.18 |     100 |     100 | 66-75,193,233                                                                                                                                                              
  jwtAuth.js                                         |      40 |    32.35 |   28.57 |   40.74 | 61,74-111,123-139,148-167                                                                                                                                                  
  rbac.js                                            |   92.98 |     90.9 |   84.61 |   92.98 | 68,83,141,178                                                                                                                                                              
  requestValidation.js                               |   79.46 |    79.01 |     100 |   80.18 | 37,41,48,52,66,85,100,119,134,154,188,208,221,236,262,267-274,287                                                                                                          
  searchLogger.js                                    |   21.42 |        0 |       0 |   21.42 | 15-41                                                                                                                                                                      
  uploadValidation.js                                |      20 |        0 |       0 |      20 | 15-61                                                                                                                                                                      
 src/migrations                                      |       0 |      100 |       0 |       0 |                                                                                                                                                                            
  20240101000001-create-episodes.js                  |       0 |      100 |       0 |       0 | 3-125                                                                                                                                                                      
  20240101000002-create-metadata-storage.js          |       0 |      100 |       0 |       0 | 3-67                                                                                                                                                                       
  20240101000003-create-thumbnails.js                |       0 |      100 |       0 |       0 | 3-87                                                                                                                                                                       
  20240101000004-create-processing-queue.js          |       0 |      100 |       0 |       0 | 3-92                                                                                                                                                                       
  20240101000005-create-activity-logs.js             |       0 |      100 |       0 |       0 | 3-73                                                                                                                                                                       
  20260104000001-add-justawomaninherprime-support.js |       0 |      100 |       0 |       0 | 11-77                                                                                                                                                                      
  20260104000002-update-composition-workflow.js      |       0 |      100 |       0 |       0 | 10-75                                                                                                                                                                      
 src/models                                          |   45.23 |        0 |   18.36 |   46.06 |                                                                                                                                                                            
  ActivityLog.js                                     |    37.5 |        0 |   16.66 |   42.85 | 117,133,144,154-164,174-189                                                                                                                                                
  Asset.js                                           |     100 |      100 |     100 |     100 |                                                                                                                                                                            
  Episode.js                                         |   46.42 |        0 |      10 |   46.42 | 217-218,225-226,233-237,244,262,269,279,288-291,298                                                                                                                        
  FileStorage.js                                     |   71.42 |      100 |      50 |   71.42 | 130-135                                                                                                                                                                    
  MetadataStorage.js                                 |      36 |        0 |   16.66 |      36 | 106-108,115-117,124-127,138,147-160                                                                                                                                        
  ProcessingQueue.js                                 |   35.55 |        0 |    7.69 |   35.55 | 137-139,146-148,155-158,165-173,180,187-190,201,213,224,234,247,257-267                                                                                                    
  Thumbnail.js                                       |   44.44 |        0 |   11.11 |   44.44 | 190-191,198-201,208-212,223,235,248,261-273,280                                                                                                                            
  ThumbnailComposition.js                            |     100 |      100 |     100 |     100 |                                                                                                                                                                            
  ThumbnailTemplate.js                               |     100 |      100 |     100 |     100 |                                                                                                                                                                            
 src/routes                                          |   38.54 |     10.5 |   20.28 |   39.52 |                                                                                                                                                                            
  assets.js                                          |      37 |    11.76 |      50 |      37 | 39-43,72-73,94-95,111-117,143-206,219-236,248-267,279-316                                                                                                                  
  auth.js                                            |   76.92 |    73.33 |     100 |   76.92 | 47,56,98-99,116,135-136,153,174-175,212-213,235-236,253                                                                                                                    
  compositions.js                                    |    13.2 |      1.5 |    6.45 |   13.28 | 48-49,57-79,92-227,240-251,263-273,285-304,316-327,339-350,362-388,400-410,423-593,607-661,673-692,704-728,739-751,762-775,786-807,818-842,853-876,887-900,926-971,987-997 
  episodes.js                                        |     100 |      100 |     100 |     100 |                                                                                                                                                                            
  files.js                                           |   79.16 |      100 |       0 |     100 |                                                                                                                                                                            
  jobs.js                                            |   66.66 |      100 |       0 |     100 |                                                                                                                                                                            
  metadata.js                                        |     100 |      100 |     100 |     100 |                                                                                                                                                                            
  processing.js                                      |     100 |      100 |     100 |     100 |                                                                                                                                                                            
  search.js                                          |   71.42 |      100 |       0 |     100 |                                                                                                                                                                            
  seed.js                                            |   41.17 |        0 |       0 |   41.17 | 92-120                                                                                                                                                                     
  templates.js                                       |   35.29 |        0 |       0 |   35.29 | 17-27,39-49                                                                                                                                                                
  thumbnails.js                                      |      50 |        0 |       0 |      50 | 96-105,117-125,137-145,156-164                                                                                                                                             
 src/services                                        |   36.68 |    26.26 |   45.87 |    36.9 |                                                                                                                                                                            
  AssetService.js                                    |   29.26 |     9.09 |   46.15 |   29.62 | 15-25,35-101,121-127,141,155-200,222-247                                                                                                                                   
  CompositionService.js                              |    3.57 |        0 |       0 |    3.75 | 16-392                                                                                                                                                                     
  FileValidationService.js                           |     100 |    97.22 |     100 |     100 | 141                                                                                                                                                                        
  FilterService.js                                   |       2 |        0 |       0 |       2 | 43-347                                                                                                                                                                     
  JobQueueService.js                                 |   96.36 |    66.66 |   91.66 |   98.11 | 95                                                                                                                                                                         
  OpenSearchService.js                               |   71.91 |     60.6 |   83.33 |   71.59 | 37-93,105-106,135-136,166-167,194-195,323-332                                                                                                                              
  RunwayMLService.js                                 |   17.94 |        0 |   16.66 |   17.94 | 21-129                                                                                                                                                                     
  S3Service.js                                       |   95.83 |    66.66 |     100 |   95.74 | 155-160                                                                                                                                                                    
  ThumbnailGeneratorService.js                       |    7.14 |        0 |       0 |    7.27 | 52-350                                                                                                                                                                     
  ThumbnailService.js                                |       0 |        0 |       0 |       0 | 1-174                                                                                                                                                                      
  VersioningService.js                               |    4.44 |        0 |       0 |    4.44 | 16-292                                                                                                                                                                     
  tokenService.js                                    |   87.75 |    65.45 |     100 |   87.75 | 24,28,98,109,128,161                                                                                                                                                       
 src/utils                                           |   41.66 |    21.42 |      25 |   41.66 |                                                                                                                                                                            
  logger.js                                          |   41.66 |    21.42 |      25 |   41.66 | 17-18,24-36                                                                                                                                                                
-----------------------------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Summary of all failing tests
FAIL tests/integration/auth.integration.test.js
  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/v1/auth/refresh ΓÇ║ should reject refresh with expired token

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 200

      151 |         });
      152 |
    > 153 |       expect(res.status).toBe(401);
          |                          ^
      154 |       expect(res.body).toHaveProperty('error');
      155 |     });
      156 |   });

      at Object.toBe (tests/integration/auth.integration.test.js:153:26)

  ΓùÅ Authentication API Integration Tests ΓÇ║ POST /api/v1/auth/logout ΓÇ║ should add token to blacklist after logout

    expect(received).toMatch(expected)

    Expected pattern: /revoked/i
    Received string:  "Token is invalid"

      196 |
      197 |       expect(validateRes.status).toBe(401);
    > 198 |       expect(validateRes.body.message).toMatch(/revoked/i);
          |                                        ^
      199 |     });
      200 |   });
      201 |

      at Object.toMatch (tests/integration/auth.integration.test.js:198:40)

  ΓùÅ Authentication API Integration Tests ΓÇ║ End-to-End Authentication Flow ΓÇ║ should complete full auth cycle: login -> use token -> refresh -> logout

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

      316 |         .set('Authorization', `Bearer ${token1}`);
      317 |
    > 318 |       expect(meRes.status).toBe(200);
          |                            ^
      319 |       expect(meRes.body.data.user.email).toBe('e2e@test.dev');
      320 |
      321 |       // 3. Refresh token

      at Object.toBe (tests/integration/auth.integration.test.js:318:28)

FAIL tests/integration/assets.integration.test.js
  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should reject asset upload without file

    expect(received).toMatch(expected)

    Matcher error: received value must be a string

    Received has value: undefined

      36 |       expect(res.status).toBe(400);
      37 |       expect(res.body).toHaveProperty('error');
    > 38 |       expect(res.body.message).toMatch(/No file provided/i);
         |                                ^
      39 |     });
      40 |
      41 |     it('should reject asset upload without assetType', async () => {

      at Object.toMatch (tests/integration/assets.integration.test.js:38:32)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should reject asset upload with invalid assetType

    expect(received).toMatch(expected)

    Expected pattern: /must be one of:/i
    Received string:  "assetType is required"

      59 |       expect(res.status).toBe(400);
      60 |       expect(res.body).toHaveProperty('error');
    > 61 |       expect(res.body.details[0]).toMatch(/must be one of:/i);
         |                                   ^
      62 |     });
      63 |
      64 |     it('should validate asset types', async () => {

      at Object.toMatch (tests/integration/assets.integration.test.js:61:35)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should validate asset types

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not 400

      79 |
      80 |         // Should not fail on validation (may fail on file processing, but not validation)
    > 81 |         expect(res.status).not.toBe(400);
         |                                ^
      82 |         // OR if it's 400, it shouldn't be validation error
      83 |         if (res.status === 400) {
      84 |           expect(res.body.error).not.toBe('Validation failed');

      at Object.toBe (tests/integration/assets.integration.test.js:81:32)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should reject invalid metadata JSON

    expect(received).toContain(expected) // indexOf

    Expected value: "Metadata must be valid JSON"
    Received array: ["assetType is required"]

       97 |       expect(res.status).toBe(400);
       98 |       expect(res.body).toHaveProperty('error');
    >  99 |       expect(res.body.details).toContain('Metadata must be valid JSON');
          |                                ^
      100 |     });
      101 |
      102 |     it('should accept valid metadata JSON', async () => {

      at Object.toContain (tests/integration/assets.integration.test.js:99:32)

  ΓùÅ Assets API Integration Tests ΓÇ║ POST /api/v1/assets ΓÇ║ should accept empty metadata

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not "Validation failed"

      125 |       // Should not be a validation error
      126 |       if (res.status === 400) {
    > 127 |         expect(res.body.error).not.toBe('Validation failed');
          |                                    ^
      128 |       }
      129 |     });
      130 |   });

      at Object.toBe (tests/integration/assets.integration.test.js:127:36)

  ΓùÅ Assets API Integration Tests ΓÇ║ Error Handling ΓÇ║ should return proper error for non-existent asset

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

      205 |         .get(`/api/v1/assets/${nonExistentId}`);
      206 |
    > 207 |       expect(res.status).toBe(404);
          |                          ^
      208 |       expect(res.body).toHaveProperty('error');
      209 |     });
      210 |

      at Object.toBe (tests/integration/assets.integration.test.js:207:26)

  ΓùÅ Assets API Integration Tests ΓÇ║ Asset Upload Validation Flow ΓÇ║ should validate all required fields before upload

    expect(received).toContain(expected) // indexOf

    Expected substring: "must be one of"
    Received string:    "assettype is required"

      255 |         // Should get validation error or other 400 error
      256 |         if (res.status === 400 && res.body.error === 'Validation failed') {
    > 257 |           expect(res.body.details[0].toLowerCase()).toContain(testCase.expectedError.toLowerCase());
          |                                                     ^
      258 |         }
      259 |       }
      260 |     });

      at Object.toContain (tests/integration/assets.integration.test.js:257:53)

FAIL tests/integration/episodes.integration.test.js
  ΓùÅ Episodes API Integration Tests ΓÇ║ GET /api/v1/episodes ΓÇ║ should filter by status

    expect(received).toBe(expected) // Object.is equality

    Expected: "approved"
    Received: "published"

      72 |       if (res.body.data.length > 0) {
      73 |         res.body.data.forEach(episode => {
    > 74 |           expect(episode.status?.toLowerCase()).toBe('approved');
         |                                                 ^
      75 |         });
      76 |       }
      77 |     });

      at toBe (tests/integration/episodes.integration.test.js:74:49)
          at Array.forEach (<anonymous>)
      at Object.forEach (tests/integration/episodes.integration.test.js:73:23)

FAIL tests/unit/controllers/episode.test.js
  ΓùÅ Episode Controller - Real Tests ΓÇ║ getEpisode() ΓÇ║ should return episode with includes

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "1", Any<Object>

    Number of calls: 0

      142 |       await episodeController.getEpisode(mockReq, mockRes);
      143 |
    > 144 |       expect(models.Episode.findByPk).toHaveBeenCalledWith('1', expect.any(Object));
          |                                       ^
      145 |       expect(mockRes.json).toHaveBeenCalledWith({ data: mockEpisode });
      146 |     });
      147 |

      at Object.toHaveBeenCalledWith (tests/unit/controllers/episode.test.js:144:39)


Test Suites: 4 failed, 22 passed, 26 total
Tests:       12 failed, 6 skipped, 811 passed, 829 total
Snapshots:   0 total
Time:        9.85 s
Ran all test suites.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
